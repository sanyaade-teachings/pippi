#include "pippicore.h"


/* Forward declarations */
void rand_preseed(void);
void rand_seed(int value);
lpfloat_t rand_base_logistic(lpfloat_t low, lpfloat_t high);
lpfloat_t rand_base_stdlib(lpfloat_t low, lpfloat_t high);
lpfloat_t rand_rand(lpfloat_t low, lpfloat_t high);
lpfloat_t rand_base_lorenz(lpfloat_t low, lpfloat_t high);
lpfloat_t rand_base_lorenzX(lpfloat_t low, lpfloat_t high);
lpfloat_t rand_base_lorenzY(lpfloat_t low, lpfloat_t high);
lpfloat_t rand_base_lorenzZ(lpfloat_t low, lpfloat_t high);
int rand_randint(int low, int high);
int rand_randbool(void);
int rand_choice(int numchoices);

lparray_t * create_array_from(int numvalues, ...);
lparray_t * create_array(size_t length);
void destroy_array(lparray_t * array);

lpbuffer_t * create_buffer(size_t length, int channels, int samplerate);
lpbuffer_t * create_buffer_from_float(lpfloat_t value, size_t length, int channels, int samplerate);
lpbuffer_t * create_buffer_from_bytes(char * bytes, size_t length, int channels, int samplerate);
lpbuffer_t * clone_buffer(lpbuffer_t * src);
void copy_buffer(lpbuffer_t * src, lpbuffer_t * dest);
void clear_buffer(lpbuffer_t * buf);
void scale_buffer(lpbuffer_t * buf, lpfloat_t from_min, lpfloat_t from_max, lpfloat_t to_min, lpfloat_t to_max);
lpfloat_t min_buffer(lpbuffer_t * buf);
lpfloat_t max_buffer(lpbuffer_t * buf);
lpfloat_t mag_buffer(lpbuffer_t * buf);
void multiply_buffer(lpbuffer_t * a, lpbuffer_t * b);
void scalar_multiply_buffer(lpbuffer_t * a, lpfloat_t b);
void add_buffers(lpbuffer_t * a, lpbuffer_t * b);
void scalar_add_buffer(lpbuffer_t * a, lpfloat_t b);
void subtract_buffers(lpbuffer_t * a, lpbuffer_t * b);
void scalar_subtract_buffer(lpbuffer_t * a, lpfloat_t b);
void divide_buffers(lpbuffer_t * a, lpbuffer_t * b);
void scalar_divide_buffer(lpbuffer_t * a, lpfloat_t b);
lpbuffer_t * concat_buffers(lpbuffer_t * a, lpbuffer_t * b);
int buffers_are_equal(lpbuffer_t * a, lpbuffer_t * b);
int buffers_are_close(lpbuffer_t * a, lpbuffer_t * b, int d);
void dub_buffer(lpbuffer_t * a, lpbuffer_t * b, size_t start);
void dub_scalar(lpbuffer_t * a, lpfloat_t, size_t start);
void env_buffer(lpbuffer_t * buf, lpbuffer_t * env);
lpbuffer_t * pad_buffer(lpbuffer_t * buf, size_t before, size_t after); 
void taper_buffer(lpbuffer_t * buf, size_t start, size_t end);
lpbuffer_t * trim_buffer(lpbuffer_t * buf, size_t start, size_t end, lpfloat_t threshold, int window);
void plot_buffer(lpbuffer_t * buf);
lpfloat_t play_buffer(lpbuffer_t * buf, lpfloat_t speed);
void split2_buffer(lpbuffer_t * src, lpbuffer_t * a, lpbuffer_t * b);
lpbuffer_t * mix_buffers(lpbuffer_t * a, lpbuffer_t * b);
lpbuffer_t * remix_buffer(lpbuffer_t * buf, int channels);
void clip_buffer(lpbuffer_t * buf, lpfloat_t minval, lpfloat_t maxval);
lpbuffer_t * cut_buffer(lpbuffer_t * buf, size_t start, size_t length);
void cut_into_buffer(lpbuffer_t * buf, lpbuffer_t * out, size_t start, size_t length);
lpbuffer_t * varispeed_buffer(lpbuffer_t * buf, lpbuffer_t * speed);
lpbuffer_t * resample_buffer(lpbuffer_t * buf, size_t length);
void pan_stereo_buffer(lpbuffer_t * buf, lpbuffer_t * pos, int method);
lpbuffer_t * fill_buffer(lpbuffer_t * buf, size_t length);
lpbuffer_t * repeat_buffer(lpbuffer_t * buf, size_t repeats);
lpbuffer_t * reverse_buffer(lpbuffer_t * buf);
lpbuffer_t * resize_buffer(lpbuffer_t *, size_t);
void destroy_buffer(lpbuffer_t * buf);

lpfloat_t read_skewed_buffer(lpfloat_t freq, lpbuffer_t * buf, lpfloat_t phase, lpfloat_t skew);
lpfloat_t fx_lpf1(lpfloat_t x, lpfloat_t * y, lpfloat_t cutoff, lpfloat_t samplerate);
void fx_convolve(lpbuffer_t * a, lpbuffer_t * b, lpbuffer_t * out);
void fx_norm(lpbuffer_t * buf, lpfloat_t ceiling);
lpfloat_t fx_fold(lpfloat_t val, lpfloat_t * prev, lpfloat_t samplerate);
lpfloat_t fx_limit(lpfloat_t val, lpfloat_t * prev, lpfloat_t threshold, lpfloat_t release, lpbuffer_t * del);
lpfloat_t fx_crush(lpfloat_t val, int bits);

lpbuffer_t * ringbuffer_create(size_t length, int channels, int samplerate);
void ringbuffer_fill(lpbuffer_t * ringbuf, lpbuffer_t * buf, int offset);
lpfloat_t ringbuffer_readone(lpbuffer_t * ringbuf, int offset);
lpbuffer_t * ringbuffer_read(lpbuffer_t * ringbuf, size_t length);
void ringbuffer_readinto(lpbuffer_t * ringbuf, lpfloat_t * data, size_t length, int channels);
void ringbuffer_writeone(lpbuffer_t * ringbuf, lpfloat_t sample);
void ringbuffer_writefrom(lpbuffer_t * ringbuf, lpfloat_t * data, size_t length, int channels);
void ringbuffer_write(lpbuffer_t * ringbuf, lpbuffer_t * buf);
void ringbuffer_dub(lpbuffer_t * buf, lpbuffer_t * src);
void ringbuffer_destroy(lpbuffer_t * buf);

void memorypool_init(unsigned char * pool, size_t poolsize);
lpmemorypool_t * memorypool_custom_init(unsigned char * pool, size_t poolsize);
void * memorypool_alloc(size_t itemcount, size_t itemsize);
void * memorypool_custom_alloc(lpmemorypool_t * pool, size_t itemcount, size_t itemsize);
void memorypool_free(void * ptr);

lpfloat_t interpolate_hermite(lpbuffer_t * buf, lpfloat_t phase);
lpfloat_t interpolate_hermite_pos(lpbuffer_t * buf, lpfloat_t pos);
lpfloat_t interpolate_linear(lpbuffer_t * buf, lpfloat_t phase);
lpfloat_t interpolate_linear_pos(lpbuffer_t * buf, lpfloat_t pos);
lpfloat_t interpolate_linear_pos2(lpfloat_t * buf, size_t length, lpfloat_t pos);
lpfloat_t interpolate_linear_channel(lpbuffer_t* buf, lpfloat_t phase, int channel);

lpbuffer_t * param_create_from_float(lpfloat_t value);
lpbuffer_t * param_create_from_int(int value);

lpbuffer_t * create_wavetable(int name, size_t length);
void destroy_wavetable(lpbuffer_t* buf);
lpbuffer_t* create_window(int name, size_t length);
lpbuffer_t * lpbuffer_create_stack(lpbuffer_t * (*table_creator)(int name, size_t length), int numtables, size_t * onsets, size_t * lengths, va_list vl);
lpbuffer_t * create_window_stack(int numtables, size_t * onsets, size_t * lengths, ...);
lpbuffer_t * create_wavetable_stack(int numtables, size_t * onsets, size_t * lengths, ...);
void destroy_window(lpbuffer_t* buf);

#ifdef LP_FLOAT
const lpfloat_t LPHANN_WINDOW[] = { 0.0000000000,0.0001517740,0.0006070039,0.0013654133,0.0024265418,0.0037897452,0.0054541958,0.0074188833,0.0096826148,0.0122440160,0.0151015320,0.0182534279,0.0216977902,0.0254325280,0.0294553737,0.0337638853,0.0383554469,0.0432272712,0.0483764003,0.0537997084,0.0594939029,0.0654555268,0.0716809611,0.0781664261,0.0849079846,0.0919015438,0.0991428580,0.1066275310,0.1143510188,0.1223086326,0.1304955414,0.1389067748,0.1475372265,0.1563816570,0.1654346968,0.1746908499,0.1841444969,0.1937898985,0.2036211990,0.2136324300,0.2238175135,0.2341702664,0.2446844034,0.2553535415,0.2661712036,0.2771308221,0.2882257437,0.2994492325,0.3107944750,0.3222545833,0.3338226003,0.3454915028,0.3572542069,0.3691035713,0.3810324025,0.3930334584,0.4050994533,0.4172230619,0.4293969241,0.4416136491,0.4538658203,0.4661459993,0.4784467310,0.4907605475,0.5030799733,0.5153975293,0.5277057375,0.5399971256,0.5522642316,0.5644996083,0.5766958274,0.5888454849,0.6009412046,0.6129756433,0.6249414949,0.6368314950,0.6486384253,0.6603551178,0.6719744593,0.6834893958,0.6948929366,0.7061781587,0.7173382109,0.7283663179,0.7392557846,0.7500000000,0.7605924414,0.7710266782,0.7812963758,0.7913952995,0.8013173182,0.8110564084,0.8206066574,0.8299622674,0.8391175587,0.8480669730,0.8568050772,0.8653265665,0.8736262674,0.8816991414,0.8895402873,0.8971449448,0.9045084972,0.9116264741,0.9184945542,0.9251085679,0.9314644998,0.9375584914,0.9433868430,0.9489460161,0.9542326359,0.9592434929,0.9639755449,0.9684259193,0.9725919141,0.9764710002,0.9800608227,0.9833592021,0.9863641361,0.9890738004,0.9914865498,0.9936009198,0.9954156265,0.9969295684,0.9981418264,0.9990516644,0.9996585301,0.9999620551,0.9999620551,0.9996585301,0.9990516644,0.9981418264,0.9969295684,0.9954156265,0.9936009198,0.9914865498,0.9890738004,0.9863641361,0.9833592021,0.9800608227,0.9764710002,0.9725919141,0.9684259193,0.9639755449,0.9592434929,0.9542326359,0.9489460161,0.9433868430,0.9375584914,0.9314644998,0.9251085679,0.9184945542,0.9116264741,0.9045084972,0.8971449448,0.8895402873,0.8816991414,0.8736262674,0.8653265665,0.8568050772,0.8480669730,0.8391175587,0.8299622674,0.8206066574,0.8110564084,0.8013173182,0.7913952995,0.7812963758,0.7710266782,0.7605924414,0.7500000000,0.7392557846,0.7283663179,0.7173382109,0.7061781587,0.6948929366,0.6834893958,0.6719744593,0.6603551178,0.6486384253,0.6368314950,0.6249414949,0.6129756433,0.6009412046,0.5888454849,0.5766958274,0.5644996083,0.5522642316,0.5399971256,0.5277057375,0.5153975293,0.5030799733,0.4907605475,0.4784467310,0.4661459993,0.4538658203,0.4416136491,0.4293969241,0.4172230619,0.4050994533,0.3930334584,0.3810324025,0.3691035713,0.3572542069,0.3454915028,0.3338226003,0.3222545833,0.3107944750,0.2994492325,0.2882257437,0.2771308221,0.2661712036,0.2553535415,0.2446844034,0.2341702664,0.2238175135,0.2136324300,0.2036211990,0.1937898985,0.1841444969,0.1746908499,0.1654346968,0.1563816570,0.1475372265,0.1389067748,0.1304955414,0.1223086326,0.1143510188,0.1066275310,0.0991428580,0.0919015438,0.0849079846,0.0781664261,0.0716809611,0.0654555268,0.0594939029,0.0537997084,0.0483764003,0.0432272712,0.0383554469,0.0337638853,0.0294553737,0.0254325280,0.0216977902,0.0182534279,0.0151015320,0.0122440160,0.0096826148,0.0074188833,0.0054541958,0.0037897452,0.0024265418,0.0013654133,0.0006070039,0.0001517740,0.0000000000 };
#else
const lpfloat_t LPHANN_WINDOW[] = { 0.0000000000,0.0000005886,0.0000023542,0.0000052970,0.0000094170,0.0000147140,0.0000211881,0.0000288392,0.0000376675,0.0000476727,0.0000588550,0.0000712143,0.0000847505,0.0000994636,0.0001153536,0.0001324205,0.0001506642,0.0001700847,0.0001906818,0.0002124557,0.0002354062,0.0002595332,0.0002848368,0.0003113168,0.0003389732,0.0003678059,0.0003978149,0.0004290001,0.0004613613,0.0004948987,0.0005296119,0.0005655011,0.0006025660,0.0006408067,0.0006802229,0.0007208147,0.0007625819,0.0008055245,0.0008496422,0.0008949351,0.0009414030,0.0009890458,0.0010378634,0.0010878557,0.0011390226,0.0011913638,0.0012448795,0.0012995693,0.0013554331,0.0014124709,0.0014706825,0.0015300677,0.0015906265,0.0016523587,0.0017152641,0.0017793425,0.0018445939,0.0019110181,0.0019786149,0.0020473842,0.0021173258,0.0021884395,0.0022607252,0.0023341826,0.0024088118,0.0024846123,0.0025615842,0.0026397271,0.0027190409,0.0027995255,0.0028811806,0.0029640060,0.0030480016,0.0031331671,0.0032195024,0.0033070072,0.0033956813,0.0034855246,0.0035765368,0.0036687177,0.0037620671,0.0038565848,0.0039522705,0.0040491240,0.0041471451,0.0042463336,0.0043466891,0.0044482116,0.0045509008,0.0046547563,0.0047597780,0.0048659656,0.0049733189,0.0050818376,0.0051915215,0.0053023703,0.0054143837,0.0055275614,0.0056419033,0.0057574091,0.0058740784,0.0059919110,0.0061109066,0.0062310649,0.0063523857,0.0064748687,0.0065985135,0.0067233200,0.0068492877,0.0069764164,0.0071047059,0.0072341557,0.0073647656,0.0074965353,0.0076294645,0.0077635528,0.0078988000,0.0080352057,0.0081727696,0.0083114914,0.0084513708,0.0085924073,0.0087346008,0.0088779509,0.0090224571,0.0091681193,0.0093149369,0.0094629098,0.0096120375,0.0097623197,0.0099137561,0.0100663462,0.0102200898,0.0103749864,0.0105310357,0.0106882374,0.0108465910,0.0110060962,0.0111667526,0.0113285598,0.0114915175,0.0116556253,0.0118208827,0.0119872894,0.0121548451,0.0123235492,0.0124934015,0.0126644015,0.0128365487,0.0130098429,0.0131842836,0.0133598704,0.0135366028,0.0137144805,0.0138935030,0.0140736699,0.0142549809,0.0144374353,0.0146210330,0.0148057733,0.0149916559,0.0151786803,0.0153668461,0.0155561529,0.0157466001,0.0159381874,0.0161309143,0.0163247804,0.0165197851,0.0167159281,0.0169132088,0.0171116269,0.0173111818,0.0175118730,0.0177137002,0.0179166627,0.0181207602,0.0183259922,0.0185323582,0.0187398576,0.0189484901,0.0191582550,0.0193691520,0.0195811805,0.0197943401,0.0200086301,0.0202240502,0.0204405998,0.0206582784,0.0208770854,0.0210970205,0.0213180830,0.0215402724,0.0217635883,0.0219880300,0.0222135971,0.0224402890,0.0226681052,0.0228970452,0.0231271084,0.0233582943,0.0235906023,0.0238240318,0.0240585824,0.0242942535,0.0245310446,0.0247689550,0.0250079842,0.0252481316,0.0254893968,0.0257317790,0.0259752778,0.0262198926,0.0264656228,0.0267124677,0.0269604270,0.0272094998,0.0274596857,0.0277109842,0.0279633944,0.0282169160,0.0284715483,0.0287272907,0.0289841425,0.0292421033,0.0295011723,0.0297613490,0.0300226328,0.0302850230,0.0305485190,0.0308131202,0.0310788260,0.0313456358,0.0316135489,0.0318825647,0.0321526825,0.0324239018,0.0326962219,0.0329696421,0.0332441618,0.0335197804,0.0337964972,0.0340743115,0.0343532228,0.0346332303,0.0349143334,0.0351965314,0.0354798237,0.0357642095,0.0360496883,0.0363362594,0.0366239220,0.0369126755,0.0372025193,0.0374934526,0.0377854747,0.0380785850,0.0383727828,0.0386680674,0.0389644380,0.0392618941,0.0395604348,0.0398600595,0.0401607675,0.0404625581,0.0407654306,0.0410693842,0.0413744182,0.0416805320,0.0419877247,0.0422959957,0.0426053443,0.0429157697,0.0432272712,0.0435398480,0.0438534995,0.0441682248,0.0444840233,0.0448008942,0.0451188367,0.0454378501,0.0457579337,0.0460790866,0.0464013083,0.0467245978,0.0470489544,0.0473743774,0.0477008659,0.0480284193,0.0483570368,0.0486867175,0.0490174607,0.0493492657,0.0496821316,0.0500160576,0.0503510430,0.0506870871,0.0510241889,0.0513623477,0.0517015627,0.0520418331,0.0523831581,0.0527255369,0.0530689687,0.0534134527,0.0537589881,0.0541055740,0.0544532097,0.0548018943,0.0551516270,0.0555024070,0.0558542334,0.0562071055,0.0565610224,0.0569159832,0.0572719872,0.0576290334,0.0579871211,0.0583462495,0.0587064175,0.0590676245,0.0594298696,0.0597931518,0.0601574704,0.0605228246,0.0608892133,0.0612566358,0.0616250913,0.0619945788,0.0623650974,0.0627366464,0.0631092247,0.0634828317,0.0638574663,0.0642331276,0.0646098149,0.0649875272,0.0653662637,0.0657460233,0.0661268053,0.0665086088,0.0668914328,0.0672752764,0.0676601388,0.0680460190,0.0684329161,0.0688208293,0.0692097575,0.0695997000,0.0699906557,0.0703826237,0.0707756032,0.0711695932,0.0715645927,0.0719606009,0.0723576168,0.0727556395,0.0731546680,0.0735547014,0.0739557388,0.0743577792,0.0747608217,0.0751648652,0.0755699090,0.0759759519,0.0763829931,0.0767910316,0.0772000665,0.0776100967,0.0780211213,0.0784331394,0.0788461499,0.0792601520,0.0796751446,0.0800911267,0.0805080974,0.0809260556,0.0813450005,0.0817649310,0.0821858461,0.0826077449,0.0830306263,0.0834544893,0.0838793330,0.0843051564,0.0847319584,0.0851597380,0.0855884943,0.0860182262,0.0864489327,0.0868806128,0.0873132655,0.0877468898,0.0881814846,0.0886170490,0.0890535818,0.0894910821,0.0899295489,0.0903689810,0.0908093775,0.0912507374,0.0916930595,0.0921363430,0.0925805866,0.0930257894,0.0934719503,0.0939190682,0.0943671422,0.0948161712,0.0952661540,0.0957170897,0.0961689772,0.0966218154,0.0970756032,0.0975303396,0.0979860236,0.0984426539,0.0989002297,0.0993587497,0.0998182129,0.1002786183,0.1007399647,0.1012022511,0.1016654763,0.1021296393,0.1025947390,0.1030607743,0.1035277440,0.1039956472,0.1044644827,0.1049342493,0.1054049460,0.1058765717,0.1063491253,0.1068226056,0.1072970116,0.1077723421,0.1082485959,0.1087257721,0.1092038694,0.1096828867,0.1101628230,0.1106436770,0.1111254476,0.1116081338,0.1120917343,0.1125762481,0.1130616739,0.1135480107,0.1140352573,0.1145234126,0.1150124754,0.1155024445,0.1159933188,0.1164850972,0.1169777784,0.1174713614,0.1179658450,0.1184612279,0.1189575091,0.1194546874,0.1199527615,0.1204517304,0.1209515929,0.1214523477,0.1219539937,0.1224565297,0.1229599545,0.1234642670,0.1239694659,0.1244755502,0.1249825184,0.1254903696,0.1259991025,0.1265087158,0.1270192085,0.1275305792,0.1280428268,0.1285559501,0.1290699479,0.1295848189,0.1301005620,0.1306171759,0.1311346594,0.1316530113,0.1321722304,0.1326923155,0.1332132653,0.1337350786,0.1342577542,0.1347812908,0.1353056872,0.1358309423,0.1363570546,0.1368840231,0.1374118464,0.1379405234,0.1384700527,0.1390004332,0.1395316635,0.1400637425,0.1405966689,0.1411304413,0.1416650587,0.1422005196,0.1427368229,0.1432739673,0.1438119515,0.1443507743,0.1448904343,0.1454309304,0.1459722612,0.1465144255,0.1470574219,0.1476012493,0.1481459063,0.1486913917,0.1492377041,0.1497848423,0.1503328050,0.1508815910,0.1514311988,0.1519816272,0.1525328750,0.1530849407,0.1536378232,0.1541915212,0.1547460332,0.1553013581,0.1558574944,0.1564144410,0.1569721964,0.1575307594,0.1580901287,0.1586503029,0.1592112807,0.1597730609,0.1603356420,0.1608990227,0.1614632018,0.1620281779,0.1625939497,0.1631605158,0.1637278749,0.1642960256,0.1648649667,0.1654346968,0.1660052146,0.1665765186,0.1671486076,0.1677214802,0.1682951351,0.1688695709,0.1694447862,0.1700207798,0.1705975502,0.1711750961,0.1717534162,0.1723325090,0.1729123732,0.1734930075,0.1740744105,0.1746565807,0.1752395169,0.1758232177,0.1764076816,0.1769929074,0.1775788936,0.1781656389,0.1787531419,0.1793414011,0.1799304152,0.1805201829,0.1811107027,0.1817019733,0.1822939932,0.1828867610,0.1834802755,0.1840745351,0.1846695384,0.1852652841,0.1858617708,0.1864589971,0.1870569615,0.1876556626,0.1882550991,0.1888552695,0.1894561724,0.1900578064,0.1906601701,0.1912632620,0.1918670808,0.1924716250,0.1930768932,0.1936828840,0.1942895960,0.1948970276,0.1955051775,0.1961140443,0.1967236265,0.1973339227,0.1979449315,0.1985566513,0.1991690809,0.1997822186,0.2003960632,0.2010106131,0.2016258669,0.2022418231,0.2028584803,0.2034758371,0.2040938920,0.2047126435,0.2053320901,0.2059522305,0.2065730632,0.2071945866,0.2078167994,0.2084397001,0.2090632872,0.2096875592,0.2103125147,0.2109381521,0.2115644701,0.2121914672,0.2128191418,0.2134474925,0.2140765178,0.2147062163,0.2153365864,0.2159676266,0.2165993356,0.2172317117,0.2178647536,0.2184984597,0.2191328285,0.2197678585,0.2204035483,0.2210398963,0.2216769010,0.2223145610,0.2229528747,0.2235918407,0.2242314574,0.2248717233,0.2255126369,0.2261541968,0.2267964013,0.2274392491,0.2280827385,0.2287268681,0.2293716363,0.2300170416,0.2306630826,0.2313097576,0.2319570652,0.2326050039,0.2332535720,0.2339027681,0.2345525907,0.2352030383,0.2358541092,0.2365058020,0.2371581151,0.2378110470,0.2384645962,0.2391187611,0.2397735401,0.2404289318,0.2410849346,0.2417415470,0.2423987673,0.2430565941,0.2437150259,0.2443740609,0.2450336978,0.2456939349,0.2463547708,0.2470162037,0.2476782323,0.2483408549,0.2490040700,0.2496678759,0.2503322712,0.2509972543,0.2516628236,0.2523289776,0.2529957146,0.2536630331,0.2543309316,0.2549994084,0.2556684620,0.2563380909,0.2570082934,0.2576790679,0.2583504130,0.2590223269,0.2596948081,0.2603678551,0.2610414663,0.2617156400,0.2623903747,0.2630656688,0.2637415206,0.2644179287,0.2650948915,0.2657724072,0.2664504744,0.2671290914,0.2678082566,0.2684879685,0.2691682254,0.2698490257,0.2705303679,0.2712122503,0.2718946713,0.2725776294,0.2732611228,0.2739451501,0.2746297095,0.2753147995,0.2760004185,0.2766865648,0.2773732369,0.2780604331,0.2787481518,0.2794363913,0.2801251501,0.2808144266,0.2815042191,0.2821945260,0.2828853456,0.2835766764,0.2842685167,0.2849608649,0.2856537193,0.2863470784,0.2870409404,0.2877353038,0.2884301670,0.2891255282,0.2898213858,0.2905177383,0.2912145840,0.2919119212,0.2926097483,0.2933080636,0.2940068655,0.2947061524,0.2954059226,0.2961061745,0.2968069063,0.2975081166,0.2982098036,0.2989119656,0.2996146010,0.3003177082,0.3010212855,0.3017253313,0.3024298438,0.3031348214,0.3038402626,0.3045461655,0.3052525286,0.3059593501,0.3066666285,0.3073743621,0.3080825491,0.3087911879,0.3095002769,0.3102098144,0.3109197987,0.3116302282,0.3123411011,0.3130524158,0.3137641706,0.3144763639,0.3151889939,0.3159020590,0.3166155575,0.3173294878,0.3180438481,0.3187586368,0.3194738522,0.3201894926,0.3209055563,0.3216220416,0.3223389469,0.3230562704,0.3237740105,0.3244921655,0.3252107337,0.3259297133,0.3266491028,0.3273689004,0.3280891044,0.3288097131,0.3295307249,0.3302521379,0.3309739506,0.3316961613,0.3324187681,0.3331417695,0.3338651637,0.3345889490,0.3353131238,0.3360376862,0.3367626347,0.3374879675,0.3382136829,0.3389397791,0.3396662545,0.3403931074,0.3411203361,0.3418479387,0.3425759138,0.3433042594,0.3440329739,0.3447620556,0.3454915028,0.3462213137,0.3469514867,0.3476820200,0.3484129119,0.3491441606,0.3498757645,0.3506077218,0.3513400309,0.3520726899,0.3528056972,0.3535390510,0.3542727496,0.3550067913,0.3557411743,0.3564758970,0.3572109575,0.3579463542,0.3586820854,0.3594181492,0.3601545440,0.3608912680,0.3616283196,0.3623656969,0.3631033982,0.3638414218,0.3645797659,0.3653184289,0.3660574089,0.3667967043,0.3675363133,0.3682762341,0.3690164650,0.3697570043,0.3704978502,0.3712390010,0.3719804550,0.3727222103,0.3734642653,0.3742066181,0.3749492671,0.3756922106,0.3764354466,0.3771789736,0.3779227897,0.3786668932,0.3794112824,0.3801559554,0.3809009106,0.3816461462,0.3823916605,0.3831374516,0.3838835178,0.3846298574,0.3853764686,0.3861233496,0.3868704988,0.3876179143,0.3883655943,0.3891135372,0.3898617411,0.3906102043,0.3913589251,0.3921079016,0.3928571321,0.3936066149,0.3943563481,0.3951063301,0.3958565590,0.3966070331,0.3973577506,0.3981087097,0.3988599087,0.3996113458,0.4003630193,0.4011149273,0.4018670681,0.4026194400,0.4033720411,0.4041248697,0.4048779240,0.4056312023,0.4063847027,0.4071384235,0.4078923629,0.4086465192,0.4094008906,0.4101554752,0.4109102714,0.4116652773,0.4124204911,0.4131759112,0.4139315356,0.4146873627,0.4154433906,0.4161996176,0.4169560419,0.4177126616,0.4184694751,0.4192264806,0.4199836762,0.4207410602,0.4214986308,0.4222563862,0.4230143246,0.4237724442,0.4245307434,0.4252892202,0.4260478728,0.4268066996,0.4275656987,0.4283248684,0.4290842067,0.4298437120,0.4306033825,0.4313632164,0.4321232118,0.4328833671,0.4336436803,0.4344041498,0.4351647737,0.4359255503,0.4366864777,0.4374475541,0.4382087778,0.4389701470,0.4397316599,0.4404933146,0.4412551095,0.4420170426,0.4427791123,0.4435413166,0.4443036539,0.4450661223,0.4458287200,0.4465914453,0.4473542963,0.4481172712,0.4488803683,0.4496435857,0.4504069217,0.4511703745,0.4519339421,0.4526976230,0.4534614152,0.4542253170,0.4549893265,0.4557534420,0.4565176617,0.4572819838,0.4580464064,0.4588109278,0.4595755461,0.4603402596,0.4611050665,0.4618699650,0.4626349532,0.4634000294,0.4641651918,0.4649304385,0.4656957678,0.4664611778,0.4672266668,0.4679922330,0.4687578745,0.4695235895,0.4702893764,0.4710552331,0.4718211580,0.4725871493,0.4733532050,0.4741193236,0.4748855030,0.4756517416,0.4764180375,0.4771843889,0.4779507940,0.4787172510,0.4794837582,0.4802503136,0.4810169155,0.4817835621,0.4825502516,0.4833169822,0.4840837521,0.4848505594,0.4856174024,0.4863842793,0.4871511882,0.4879181274,0.4886850950,0.4894520892,0.4902191083,0.4909861504,0.4917532138,0.4925202965,0.4932873968,0.4940545130,0.4948216431,0.4955887855,0.4963559382,0.4971230995,0.4978902676,0.4986574407,0.4994246169,0.5001917944,0.5009589715,0.5017261464,0.5024933172,0.5032604821,0.5040276393,0.5047947871,0.5055619236,0.5063290469,0.5070961554,0.5078632472,0.5086303205,0.5093973734,0.5101644042,0.5109314111,0.5116983923,0.5124653459,0.5132322701,0.5139991632,0.5147660234,0.5155328488,0.5162996376,0.5170663881,0.5178330984,0.5185997666,0.5193663911,0.5201329701,0.5208995016,0.5216659839,0.5224324152,0.5231987937,0.5239651175,0.5247313850,0.5254975942,0.5262637434,0.5270298308,0.5277958545,0.5285618128,0.5293277039,0.5300935259,0.5308592771,0.5316249556,0.5323905596,0.5331560875,0.5339215372,0.5346869071,0.5354521953,0.5362174001,0.5369825196,0.5377475520,0.5385124956,0.5392773485,0.5400421089,0.5408067751,0.5415713452,0.5423358174,0.5431001899,0.5438644610,0.5446286288,0.5453926916,0.5461566475,0.5469204947,0.5476842315,0.5484478560,0.5492113664,0.5499747610,0.5507380379,0.5515011954,0.5522642316,0.5530271448,0.5537899332,0.5545525949,0.5553151282,0.5560775313,0.5568398023,0.5576019395,0.5583639411,0.5591258054,0.5598875304,0.5606491144,0.5614105557,0.5621718523,0.5629330026,0.5636940048,0.5644548570,0.5652155574,0.5659761043,0.5667364959,0.5674967304,0.5682568060,0.5690167209,0.5697764732,0.5705360614,0.5712954834,0.5720547377,0.5728138223,0.5735727354,0.5743314754,0.5750900403,0.5758484285,0.5766066381,0.5773646674,0.5781225145,0.5788801777,0.5796376552,0.5803949453,0.5811520460,0.5819089557,0.5826656726,0.5834221948,0.5841785207,0.5849346483,0.5856905761,0.5864463020,0.5872018245,0.5879571417,0.5887122518,0.5894671530,0.5902218437,0.5909763219,0.5917305859,0.5924846340,0.5932384643,0.5939920752,0.5947454647,0.5954986312,0.5962515729,0.5970042880,0.5977567747,0.5985090313,0.5992610559,0.6000128469,0.6007644024,0.6015157207,0.6022668000,0.6030176385,0.6037682345,0.6045185862,0.6052686919,0.6060185497,0.6067681579,0.6075175148,0.6082666185,0.6090154674,0.6097640596,0.6105123934,0.6112604670,0.6120082787,0.6127558267,0.6135031092,0.6142501245,0.6149968709,0.6157433465,0.6164895496,0.6172354785,0.6179811314,0.6187265065,0.6194716021,0.6202164165,0.6209609478,0.6217051944,0.6224491544,0.6231928262,0.6239362079,0.6246792978,0.6254220943,0.6261645954,0.6269067996,0.6276487049,0.6283903098,0.6291316124,0.6298726109,0.6306133038,0.6313536891,0.6320937652,0.6328335303,0.6335729827,0.6343121206,0.6350509423,0.6357894461,0.6365276302,0.6372654929,0.6380030324,0.6387402470,0.6394771350,0.6402136947,0.6409499242,0.6416858219,0.6424213860,0.6431566149,0.6438915067,0.6446260598,0.6453602723,0.6460941427,0.6468276691,0.6475608499,0.6482936833,0.6490261675,0.6497583009,0.6504900817,0.6512215083,0.6519525788,0.6526832916,0.6534136449,0.6541436371,0.6548732664,0.6556025310,0.6563314294,0.6570599596,0.6577881202,0.6585159092,0.6592433251,0.6599703661,0.6606970305,0.6614233165,0.6621492225,0.6628747468,0.6635998877,0.6643246433,0.6650490122,0.6657729924,0.6664965824,0.6672197804,0.6679425847,0.6686649937,0.6693870056,0.6701086187,0.6708298313,0.6715506417,0.6722710483,0.6729910493,0.6737106430,0.6744298278,0.6751486020,0.6758669637,0.6765849115,0.6773024435,0.6780195581,0.6787362537,0.6794525284,0.6801683806,0.6808838087,0.6815988110,0.6823133857,0.6830275312,0.6837412458,0.6844545278,0.6851673756,0.6858797875,0.6865917617,0.6873032967,0.6880143907,0.6887250421,0.6894352492,0.6901450103,0.6908543237,0.6915631879,0.6922716010,0.6929795615,0.6936870677,0.6943941178,0.6951007104,0.6958068436,0.6965125158,0.6972177254,0.6979224707,0.6986267501,0.6993305618,0.7000339042,0.7007367758,0.7014391747,0.7021410994,0.7028425482,0.7035435195,0.7042440116,0.7049440228,0.7056435516,0.7063425962,0.7070411550,0.7077392264,0.7084368088,0.7091339004,0.7098304997,0.7105266049,0.7112222146,0.7119173270,0.7126119405,0.7133060534,0.7139996641,0.7146927711,0.7153853726,0.7160774671,0.7167690528,0.7174601282,0.7181506917,0.7188407416,0.7195302762,0.7202192941,0.7209077935,0.7215957728,0.7222832304,0.7229701648,0.7236565742,0.7243424570,0.7250278117,0.7257126366,0.7263969302,0.7270806907,0.7277639167,0.7284466064,0.7291287583,0.7298103708,0.7304914423,0.7311719711,0.7318519557,0.7325313945,0.7332102858,0.7338886281,0.7345664197,0.7352436591,0.7359203447,0.7365964749,0.7372720481,0.7379470627,0.7386215171,0.7392954097,0.7399687390,0.7406415033,0.7413137011,0.7419853308,0.7426563908,0.7433268795,0.7439967953,0.7446661368,0.7453349022,0.7460030900,0.7466706987,0.7473377267,0.7480041724,0.7486700342,0.7493353106,0.7500000000,0.7506641008,0.7513276115,0.7519905306,0.7526528563,0.7533145873,0.7539757219,0.7546362586,0.7552961958,0.7559555319,0.7566142655,0.7572723950,0.7579299188,0.7585868353,0.7592431431,0.7598988405,0.7605539261,0.7612083982,0.7618622555,0.7625154962,0.7631681189,0.7638201221,0.7644715041,0.7651222635,0.7657723988,0.7664219083,0.7670707907,0.7677190442,0.7683666676,0.7690136591,0.7696600172,0.7703057406,0.7709508276,0.7715952766,0.7722390863,0.7728822551,0.7735247814,0.7741666638,0.7748079008,0.7754484907,0.7760884322,0.7767277237,0.7773663638,0.7780043508,0.7786416834,0.7792783599,0.7799143790,0.7805497391,0.7811844387,0.7818184763,0.7824518504,0.7830845596,0.7837166024,0.7843479772,0.7849786826,0.7856087170,0.7862380791,0.7868667673,0.7874947801,0.7881221162,0.7887487739,0.7893747518,0.7900000484,0.7906246623,0.7912485921,0.7918718361,0.7924943930,0.7931162613,0.7937374396,0.7943579263,0.7949777200,0.7955968193,0.7962152226,0.7968329286,0.7974499358,0.7980662427,0.7986818479,0.7992967499,0.7999109473,0.8005244387,0.8011372225,0.8017492974,0.8023606619,0.8029713145,0.8035812539,0.8041904786,0.8047989871,0.8054067781,0.8060138501,0.8066202016,0.8072258313,0.8078307377,0.8084349193,0.8090383749,0.8096411029,0.8102431019,0.8108443705,0.8114449074,0.8120447110,0.8126437800,0.8132421129,0.8138397084,0.8144365651,0.8150326814,0.8156280562,0.8162226878,0.8168165750,0.8174097163,0.8180021104,0.8185937558,0.8191846511,0.8197747950,0.8203641861,0.8209528230,0.8215407042,0.8221278285,0.8227141944,0.8232998006,0.8238846456,0.8244687282,0.8250520468,0.8256346002,0.8262163870,0.8267974058,0.8273776552,0.8279571339,0.8285358405,0.8291137737,0.8296909320,0.8302673142,0.8308429188,0.8314177445,0.8319917900,0.8325650540,0.8331375349,0.8337092316,0.8342801427,0.8348502668,0.8354196025,0.8359881486,0.8365559037,0.8371228665,0.8376890356,0.8382544097,0.8388189874,0.8393827675,0.8399457486,0.8405079294,0.8410693085,0.8416298847,0.8421896566,0.8427486229,0.8433067823,0.8438641335,0.8444206751,0.8449764059,0.8455313245,0.8460854296,0.8466387200,0.8471911943,0.8477428512,0.8482936895,0.8488437078,0.8493929048,0.8499412793,0.8504888299,0.8510355554,0.8515814544,0.8521265258,0.8526707682,0.8532141802,0.8537567608,0.8542985085,0.8548394221,0.8553795003,0.8559187418,0.8564571455,0.8569947099,0.8575314339,0.8580673162,0.8586023555,0.8591365506,0.8596699002,0.8602024030,0.8607340578,0.8612648634,0.8617948184,0.8623239217,0.8628521720,0.8633795681,0.8639061086,0.8644317925,0.8649566184,0.8654805851,0.8660036913,0.8665259359,0.8670473176,0.8675678352,0.8680874874,0.8686062731,0.8691241910,0.8696412398,0.8701574185,0.8706727257,0.8711871602,0.8717007209,0.8722134065,0.8727252158,0.8732361477,0.8737462008,0.8742553741,0.8747636663,0.8752710761,0.8757776025,0.8762832443,0.8767880001,0.8772918689,0.8777948495,0.8782969407,0.8787981412,0.8792984500,0.8797978658,0.8802963875,0.8807940138,0.8812907437,0.8817865759,0.8822815093,0.8827755427,0.8832686750,0.8837609049,0.8842522314,0.8847426533,0.8852321694,0.8857207785,0.8862084796,0.8866952715,0.8871811529,0.8876661229,0.8881501802,0.8886333237,0.8891155522,0.8895968647,0.8900772599,0.8905567369,0.8910352943,0.8915129312,0.8919896464,0.8924654387,0.8929403070,0.8934142503,0.8938872674,0.8943593572,0.8948305185,0.8953007503,0.8957700515,0.8962384210,0.8967058576,0.8971723602,0.8976379279,0.8981025594,0.8985662536,0.8990290095,0.8994908261,0.8999517021,0.9004116365,0.9008706283,0.9013286763,0.9017857795,0.9022419368,0.9026971471,0.9031514094,0.9036047225,0.9040570855,0.9045084972,0.9049589566,0.9054084626,0.9058570142,0.9063046103,0.9067512499,0.9071969319,0.9076416552,0.9080854188,0.9085282218,0.9089700629,0.9094109412,0.9098508557,0.9102898053,0.9107277889,0.9111648056,0.9116008543,0.9120359340,0.9124700437,0.9129031823,0.9133353489,0.9137665423,0.9141967616,0.9146260059,0.9150542739,0.9154815649,0.9159078777,0.9163332113,0.9167575648,0.9171809372,0.9176033274,0.9180247345,0.9184451574,0.9188645952,0.9192830469,0.9197005115,0.9201169880,0.9205324755,0.9209469729,0.9213604793,0.9217729938,0.9221845152,0.9225950428,0.9230045754,0.9234131122,0.9238206522,0.9242271944,0.9246327379,0.9250372816,0.9254408248,0.9258433663,0.9262449053,0.9266454408,0.9270449719,0.9274434976,0.9278410170,0.9282375292,0.9286330332,0.9290275281,0.9294210129,0.9298134868,0.9302049488,0.9305953980,0.9309848334,0.9313732543,0.9317606595,0.9321470483,0.9325324197,0.9329167728,0.9333001068,0.9336824206,0.9340637134,0.9344439844,0.9348232325,0.9352014570,0.9355786569,0.9359548313,0.9363299794,0.9367041003,0.9370771931,0.9374492568,0.9378202908,0.9381902939,0.9385592655,0.9389272046,0.9392941103,0.9396599819,0.9400248184,0.9403886189,0.9407513827,0.9411131088,0.9414737964,0.9418334447,0.9421920528,0.9425496199,0.9429061451,0.9432616277,0.9436160666,0.9439694612,0.9443218106,0.9446731139,0.9450233703,0.9453725791,0.9457207393,0.9460678502,0.9464139110,0.9467589208,0.9471028788,0.9474457842,0.9477876362,0.9481284340,0.9484681768,0.9488068638,0.9491444942,0.9494810672,0.9498165820,0.9501510379,0.9504844340,0.9508167695,0.9511480437,0.9514782557,0.9518074049,0.9521354904,0.9524625115,0.9527884674,0.9531133573,0.9534371804,0.9537599361,0.9540816235,0.9544022418,0.9547217904,0.9550402685,0.9553576753,0.9556740101,0.9559892721,0.9563034605,0.9566165748,0.9569286140,0.9572395776,0.9575494646,0.9578582745,0.9581660065,0.9584726598,0.9587782338,0.9590827277,0.9593861408,0.9596884724,0.9599897218,0.9602898883,0.9605889711,0.9608869696,0.9611838830,0.9614797107,0.9617744520,0.9620681061,0.9623606724,0.9626521502,0.9629425388,0.9632318376,0.9635200457,0.9638071626,0.9640931876,0.9643781201,0.9646619592,0.9649447044,0.9652263551,0.9655069104,0.9657863699,0.9660647328,0.9663419984,0.9666181662,0.9668932354,0.9671672055,0.9674400757,0.9677118455,0.9679825141,0.9682520810,0.9685205455,0.9687879070,0.9690541649,0.9693193185,0.9695833672,0.9698463104,0.9701081474,0.9703688778,0.9706285007,0.9708870157,0.9711444220,0.9714007192,0.9716559066,0.9719099836,0.9721629496,0.9724148041,0.9726655463,0.9729151758,0.9731636919,0.9734110941,0.9736573817,0.9739025543,0.9741466111,0.9743895517,0.9746313755,0.9748720818,0.9751116702,0.9753501401,0.9755874909,0.9758237220,0.9760588330,0.9762928231,0.9765256920,0.9767574390,0.9769880636,0.9772175652,0.9774459434,0.9776731975,0.9778993271,0.9781243316,0.9783482104,0.9785709631,0.9787925892,0.9790130880,0.9792324591,0.9794507020,0.9796678162,0.9798838011,0.9800986562,0.9803123810,0.9805249751,0.9807364379,0.9809467690,0.9811559677,0.9813640338,0.9815709665,0.9817767655,0.9819814303,0.9821849604,0.9823873554,0.9825886146,0.9827887378,0.9829877243,0.9831855737,0.9833822857,0.9835778596,0.9837722950,0.9839655916,0.9841577487,0.9843487661,0.9845386431,0.9847273794,0.9849149746,0.9851014282,0.9852867397,0.9854709087,0.9856539348,0.9858358176,0.9860165566,0.9861961513,0.9863746015,0.9865519066,0.9867280663,0.9869030800,0.9870769475,0.9872496683,0.9874212420,0.9875916681,0.9877609464,0.9879290763,0.9880960576,0.9882618897,0.9884265724,0.9885901051,0.9887524876,0.9889137195,0.9890738004,0.9892327298,0.9893905075,0.9895471330,0.9897026060,0.9898569262,0.9900100931,0.9901621063,0.9903129657,0.9904626707,0.9906112210,0.9907586163,0.9909048563,0.9910499405,0.9911938687,0.9913366405,0.9914782556,0.9916187136,0.9917580142,0.9918961571,0.9920331420,0.9921689684,0.9923036362,0.9924371450,0.9925694945,0.9927006844,0.9928307143,0.9929595839,0.9930872930,0.9932138413,0.9933392284,0.9934634541,0.9935865181,0.9937084200,0.9938291596,0.9939487366,0.9940671507,0.9941844017,0.9943004893,0.9944154131,0.9945291730,0.9946417686,0.9947531997,0.9948634661,0.9949725674,0.9950805034,0.9951872739,0.9952928786,0.9953973173,0.9955005896,0.9956026955,0.9957036345,0.9958034066,0.9959020114,0.9959994487,0.9960957184,0.9961908201,0.9962847536,0.9963775188,0.9964691154,0.9965595431,0.9966488019,0.9967368914,0.9968238115,0.9969095619,0.9969941425,0.9970775530,0.9971597933,0.9972408631,0.9973207623,0.9973994908,0.9974770482,0.9975534344,0.9976286492,0.9977026926,0.9977755642,0.9978472639,0.9979177916,0.9979871470,0.9980553301,0.9981223406,0.9981881784,0.9982528433,0.9983163353,0.9983786541,0.9984397995,0.9984997716,0.9985585700,0.9986161947,0.9986726456,0.9987279224,0.9987820251,0.9988349536,0.9988867077,0.9989372873,0.9989866922,0.9990349224,0.9990819778,0.9991278582,0.9991725635,0.9992160937,0.9992584486,0.9992996281,0.9993396321,0.9993784606,0.9994161134,0.9994525905,0.9994878917,0.9995220170,0.9995549663,0.9995867395,0.9996173366,0.9996467575,0.9996750021,0.9997020703,0.9997279621,0.9997526774,0.9997762161,0.9997985783,0.9998197638,0.9998397727,0.9998586047,0.9998762600,0.9998927385,0.9999080401,0.9999221647,0.9999351125,0.9999468833,0.9999574770,0.9999668938,0.9999751335,0.9999821961,0.9999880817,0.9999927901,0.9999963215,0.9999986757,0.9999998529,0.9999998529,0.9999986757,0.9999963215,0.9999927901,0.9999880817,0.9999821961,0.9999751335,0.9999668938,0.9999574770,0.9999468833,0.9999351125,0.9999221647,0.9999080401,0.9998927385,0.9998762600,0.9998586047,0.9998397727,0.9998197638,0.9997985783,0.9997762161,0.9997526774,0.9997279621,0.9997020703,0.9996750021,0.9996467575,0.9996173366,0.9995867395,0.9995549663,0.9995220170,0.9994878917,0.9994525905,0.9994161134,0.9993784606,0.9993396321,0.9992996281,0.9992584486,0.9992160937,0.9991725635,0.9991278582,0.9990819778,0.9990349224,0.9989866922,0.9989372873,0.9988867077,0.9988349536,0.9987820251,0.9987279224,0.9986726456,0.9986161947,0.9985585700,0.9984997716,0.9984397995,0.9983786541,0.9983163353,0.9982528433,0.9981881784,0.9981223406,0.9980553301,0.9979871470,0.9979177916,0.9978472639,0.9977755642,0.9977026926,0.9976286492,0.9975534344,0.9974770482,0.9973994908,0.9973207623,0.9972408631,0.9971597933,0.9970775530,0.9969941425,0.9969095619,0.9968238115,0.9967368914,0.9966488019,0.9965595431,0.9964691154,0.9963775188,0.9962847536,0.9961908201,0.9960957184,0.9959994487,0.9959020114,0.9958034066,0.9957036345,0.9956026955,0.9955005896,0.9953973173,0.9952928786,0.9951872739,0.9950805034,0.9949725674,0.9948634661,0.9947531997,0.9946417686,0.9945291730,0.9944154131,0.9943004893,0.9941844017,0.9940671507,0.9939487366,0.9938291596,0.9937084200,0.9935865181,0.9934634541,0.9933392284,0.9932138413,0.9930872930,0.9929595839,0.9928307143,0.9927006844,0.9925694945,0.9924371450,0.9923036362,0.9921689684,0.9920331420,0.9918961571,0.9917580142,0.9916187136,0.9914782556,0.9913366405,0.9911938687,0.9910499405,0.9909048563,0.9907586163,0.9906112210,0.9904626707,0.9903129657,0.9901621063,0.9900100931,0.9898569262,0.9897026060,0.9895471330,0.9893905075,0.9892327298,0.9890738004,0.9889137195,0.9887524876,0.9885901051,0.9884265724,0.9882618897,0.9880960576,0.9879290763,0.9877609464,0.9875916681,0.9874212420,0.9872496683,0.9870769475,0.9869030800,0.9867280663,0.9865519066,0.9863746015,0.9861961513,0.9860165566,0.9858358176,0.9856539348,0.9854709087,0.9852867397,0.9851014282,0.9849149746,0.9847273794,0.9845386431,0.9843487661,0.9841577487,0.9839655916,0.9837722950,0.9835778596,0.9833822857,0.9831855737,0.9829877243,0.9827887378,0.9825886146,0.9823873554,0.9821849604,0.9819814303,0.9817767655,0.9815709665,0.9813640338,0.9811559677,0.9809467690,0.9807364379,0.9805249751,0.9803123810,0.9800986562,0.9798838011,0.9796678162,0.9794507020,0.9792324591,0.9790130880,0.9787925892,0.9785709631,0.9783482104,0.9781243316,0.9778993271,0.9776731975,0.9774459434,0.9772175652,0.9769880636,0.9767574390,0.9765256920,0.9762928231,0.9760588330,0.9758237220,0.9755874909,0.9753501401,0.9751116702,0.9748720818,0.9746313755,0.9743895517,0.9741466111,0.9739025543,0.9736573817,0.9734110941,0.9731636919,0.9729151758,0.9726655463,0.9724148041,0.9721629496,0.9719099836,0.9716559066,0.9714007192,0.9711444220,0.9708870157,0.9706285007,0.9703688778,0.9701081474,0.9698463104,0.9695833672,0.9693193185,0.9690541649,0.9687879070,0.9685205455,0.9682520810,0.9679825141,0.9677118455,0.9674400757,0.9671672055,0.9668932354,0.9666181662,0.9663419984,0.9660647328,0.9657863699,0.9655069104,0.9652263551,0.9649447044,0.9646619592,0.9643781201,0.9640931876,0.9638071626,0.9635200457,0.9632318376,0.9629425388,0.9626521502,0.9623606724,0.9620681061,0.9617744520,0.9614797107,0.9611838830,0.9608869696,0.9605889711,0.9602898883,0.9599897218,0.9596884724,0.9593861408,0.9590827277,0.9587782338,0.9584726598,0.9581660065,0.9578582745,0.9575494646,0.9572395776,0.9569286140,0.9566165748,0.9563034605,0.9559892721,0.9556740101,0.9553576753,0.9550402685,0.9547217904,0.9544022418,0.9540816235,0.9537599361,0.9534371804,0.9531133573,0.9527884674,0.9524625115,0.9521354904,0.9518074049,0.9514782557,0.9511480437,0.9508167695,0.9504844340,0.9501510379,0.9498165820,0.9494810672,0.9491444942,0.9488068638,0.9484681768,0.9481284340,0.9477876362,0.9474457842,0.9471028788,0.9467589208,0.9464139110,0.9460678502,0.9457207393,0.9453725791,0.9450233703,0.9446731139,0.9443218106,0.9439694612,0.9436160666,0.9432616277,0.9429061451,0.9425496199,0.9421920528,0.9418334447,0.9414737964,0.9411131088,0.9407513827,0.9403886189,0.9400248184,0.9396599819,0.9392941103,0.9389272046,0.9385592655,0.9381902939,0.9378202908,0.9374492568,0.9370771931,0.9367041003,0.9363299794,0.9359548313,0.9355786569,0.9352014570,0.9348232325,0.9344439844,0.9340637134,0.9336824206,0.9333001068,0.9329167728,0.9325324197,0.9321470483,0.9317606595,0.9313732543,0.9309848334,0.9305953980,0.9302049488,0.9298134868,0.9294210129,0.9290275281,0.9286330332,0.9282375292,0.9278410170,0.9274434976,0.9270449719,0.9266454408,0.9262449053,0.9258433663,0.9254408248,0.9250372816,0.9246327379,0.9242271944,0.9238206522,0.9234131122,0.9230045754,0.9225950428,0.9221845152,0.9217729938,0.9213604793,0.9209469729,0.9205324755,0.9201169880,0.9197005115,0.9192830469,0.9188645952,0.9184451574,0.9180247345,0.9176033274,0.9171809372,0.9167575648,0.9163332113,0.9159078777,0.9154815649,0.9150542739,0.9146260059,0.9141967616,0.9137665423,0.9133353489,0.9129031823,0.9124700437,0.9120359340,0.9116008543,0.9111648056,0.9107277889,0.9102898053,0.9098508557,0.9094109412,0.9089700629,0.9085282218,0.9080854188,0.9076416552,0.9071969319,0.9067512499,0.9063046103,0.9058570142,0.9054084626,0.9049589566,0.9045084972,0.9040570855,0.9036047225,0.9031514094,0.9026971471,0.9022419368,0.9017857795,0.9013286763,0.9008706283,0.9004116365,0.8999517021,0.8994908261,0.8990290095,0.8985662536,0.8981025594,0.8976379279,0.8971723602,0.8967058576,0.8962384210,0.8957700515,0.8953007503,0.8948305185,0.8943593572,0.8938872674,0.8934142503,0.8929403070,0.8924654387,0.8919896464,0.8915129312,0.8910352943,0.8905567369,0.8900772599,0.8895968647,0.8891155522,0.8886333237,0.8881501802,0.8876661229,0.8871811529,0.8866952715,0.8862084796,0.8857207785,0.8852321694,0.8847426533,0.8842522314,0.8837609049,0.8832686750,0.8827755427,0.8822815093,0.8817865759,0.8812907437,0.8807940138,0.8802963875,0.8797978658,0.8792984500,0.8787981412,0.8782969407,0.8777948495,0.8772918689,0.8767880001,0.8762832443,0.8757776025,0.8752710761,0.8747636663,0.8742553741,0.8737462008,0.8732361477,0.8727252158,0.8722134065,0.8717007209,0.8711871602,0.8706727257,0.8701574185,0.8696412398,0.8691241910,0.8686062731,0.8680874874,0.8675678352,0.8670473176,0.8665259359,0.8660036913,0.8654805851,0.8649566184,0.8644317925,0.8639061086,0.8633795681,0.8628521720,0.8623239217,0.8617948184,0.8612648634,0.8607340578,0.8602024030,0.8596699002,0.8591365506,0.8586023555,0.8580673162,0.8575314339,0.8569947099,0.8564571455,0.8559187418,0.8553795003,0.8548394221,0.8542985085,0.8537567608,0.8532141802,0.8526707682,0.8521265258,0.8515814544,0.8510355554,0.8504888299,0.8499412793,0.8493929048,0.8488437078,0.8482936895,0.8477428512,0.8471911943,0.8466387200,0.8460854296,0.8455313245,0.8449764059,0.8444206751,0.8438641335,0.8433067823,0.8427486229,0.8421896566,0.8416298847,0.8410693085,0.8405079294,0.8399457486,0.8393827675,0.8388189874,0.8382544097,0.8376890356,0.8371228665,0.8365559037,0.8359881486,0.8354196025,0.8348502668,0.8342801427,0.8337092316,0.8331375349,0.8325650540,0.8319917900,0.8314177445,0.8308429188,0.8302673142,0.8296909320,0.8291137737,0.8285358405,0.8279571339,0.8273776552,0.8267974058,0.8262163870,0.8256346002,0.8250520468,0.8244687282,0.8238846456,0.8232998006,0.8227141944,0.8221278285,0.8215407042,0.8209528230,0.8203641861,0.8197747950,0.8191846511,0.8185937558,0.8180021104,0.8174097163,0.8168165750,0.8162226878,0.8156280562,0.8150326814,0.8144365651,0.8138397084,0.8132421129,0.8126437800,0.8120447110,0.8114449074,0.8108443705,0.8102431019,0.8096411029,0.8090383749,0.8084349193,0.8078307377,0.8072258313,0.8066202016,0.8060138501,0.8054067781,0.8047989871,0.8041904786,0.8035812539,0.8029713145,0.8023606619,0.8017492974,0.8011372225,0.8005244387,0.7999109473,0.7992967499,0.7986818479,0.7980662427,0.7974499358,0.7968329286,0.7962152226,0.7955968193,0.7949777200,0.7943579263,0.7937374396,0.7931162613,0.7924943930,0.7918718361,0.7912485921,0.7906246623,0.7900000484,0.7893747518,0.7887487739,0.7881221162,0.7874947801,0.7868667673,0.7862380791,0.7856087170,0.7849786826,0.7843479772,0.7837166024,0.7830845596,0.7824518504,0.7818184763,0.7811844387,0.7805497391,0.7799143790,0.7792783599,0.7786416834,0.7780043508,0.7773663638,0.7767277237,0.7760884322,0.7754484907,0.7748079008,0.7741666638,0.7735247814,0.7728822551,0.7722390863,0.7715952766,0.7709508276,0.7703057406,0.7696600172,0.7690136591,0.7683666676,0.7677190442,0.7670707907,0.7664219083,0.7657723988,0.7651222635,0.7644715041,0.7638201221,0.7631681189,0.7625154962,0.7618622555,0.7612083982,0.7605539261,0.7598988405,0.7592431431,0.7585868353,0.7579299188,0.7572723950,0.7566142655,0.7559555319,0.7552961958,0.7546362586,0.7539757219,0.7533145873,0.7526528563,0.7519905306,0.7513276115,0.7506641008,0.7500000000,0.7493353106,0.7486700342,0.7480041724,0.7473377267,0.7466706987,0.7460030900,0.7453349022,0.7446661368,0.7439967953,0.7433268795,0.7426563908,0.7419853308,0.7413137011,0.7406415033,0.7399687390,0.7392954097,0.7386215171,0.7379470627,0.7372720481,0.7365964749,0.7359203447,0.7352436591,0.7345664197,0.7338886281,0.7332102858,0.7325313945,0.7318519557,0.7311719711,0.7304914423,0.7298103708,0.7291287583,0.7284466064,0.7277639167,0.7270806907,0.7263969302,0.7257126366,0.7250278117,0.7243424570,0.7236565742,0.7229701648,0.7222832304,0.7215957728,0.7209077935,0.7202192941,0.7195302762,0.7188407416,0.7181506917,0.7174601282,0.7167690528,0.7160774671,0.7153853726,0.7146927711,0.7139996641,0.7133060534,0.7126119405,0.7119173270,0.7112222146,0.7105266049,0.7098304997,0.7091339004,0.7084368088,0.7077392264,0.7070411550,0.7063425962,0.7056435516,0.7049440228,0.7042440116,0.7035435195,0.7028425482,0.7021410994,0.7014391747,0.7007367758,0.7000339042,0.6993305618,0.6986267501,0.6979224707,0.6972177254,0.6965125158,0.6958068436,0.6951007104,0.6943941178,0.6936870677,0.6929795615,0.6922716010,0.6915631879,0.6908543237,0.6901450103,0.6894352492,0.6887250421,0.6880143907,0.6873032967,0.6865917617,0.6858797875,0.6851673756,0.6844545278,0.6837412458,0.6830275312,0.6823133857,0.6815988110,0.6808838087,0.6801683806,0.6794525284,0.6787362537,0.6780195581,0.6773024435,0.6765849115,0.6758669637,0.6751486020,0.6744298278,0.6737106430,0.6729910493,0.6722710483,0.6715506417,0.6708298313,0.6701086187,0.6693870056,0.6686649937,0.6679425847,0.6672197804,0.6664965824,0.6657729924,0.6650490122,0.6643246433,0.6635998877,0.6628747468,0.6621492225,0.6614233165,0.6606970305,0.6599703661,0.6592433251,0.6585159092,0.6577881202,0.6570599596,0.6563314294,0.6556025310,0.6548732664,0.6541436371,0.6534136449,0.6526832916,0.6519525788,0.6512215083,0.6504900817,0.6497583009,0.6490261675,0.6482936833,0.6475608499,0.6468276691,0.6460941427,0.6453602723,0.6446260598,0.6438915067,0.6431566149,0.6424213860,0.6416858219,0.6409499242,0.6402136947,0.6394771350,0.6387402470,0.6380030324,0.6372654929,0.6365276302,0.6357894461,0.6350509423,0.6343121206,0.6335729827,0.6328335303,0.6320937652,0.6313536891,0.6306133038,0.6298726109,0.6291316124,0.6283903098,0.6276487049,0.6269067996,0.6261645954,0.6254220943,0.6246792978,0.6239362079,0.6231928262,0.6224491544,0.6217051944,0.6209609478,0.6202164165,0.6194716021,0.6187265065,0.6179811314,0.6172354785,0.6164895496,0.6157433465,0.6149968709,0.6142501245,0.6135031092,0.6127558267,0.6120082787,0.6112604670,0.6105123934,0.6097640596,0.6090154674,0.6082666185,0.6075175148,0.6067681579,0.6060185497,0.6052686919,0.6045185862,0.6037682345,0.6030176385,0.6022668000,0.6015157207,0.6007644024,0.6000128469,0.5992610559,0.5985090313,0.5977567747,0.5970042880,0.5962515729,0.5954986312,0.5947454647,0.5939920752,0.5932384643,0.5924846340,0.5917305859,0.5909763219,0.5902218437,0.5894671530,0.5887122518,0.5879571417,0.5872018245,0.5864463020,0.5856905761,0.5849346483,0.5841785207,0.5834221948,0.5826656726,0.5819089557,0.5811520460,0.5803949453,0.5796376552,0.5788801777,0.5781225145,0.5773646674,0.5766066381,0.5758484285,0.5750900403,0.5743314754,0.5735727354,0.5728138223,0.5720547377,0.5712954834,0.5705360614,0.5697764732,0.5690167209,0.5682568060,0.5674967304,0.5667364959,0.5659761043,0.5652155574,0.5644548570,0.5636940048,0.5629330026,0.5621718523,0.5614105557,0.5606491144,0.5598875304,0.5591258054,0.5583639411,0.5576019395,0.5568398023,0.5560775313,0.5553151282,0.5545525949,0.5537899332,0.5530271448,0.5522642316,0.5515011954,0.5507380379,0.5499747610,0.5492113664,0.5484478560,0.5476842315,0.5469204947,0.5461566475,0.5453926916,0.5446286288,0.5438644610,0.5431001899,0.5423358174,0.5415713452,0.5408067751,0.5400421089,0.5392773485,0.5385124956,0.5377475520,0.5369825196,0.5362174001,0.5354521953,0.5346869071,0.5339215372,0.5331560875,0.5323905596,0.5316249556,0.5308592771,0.5300935259,0.5293277039,0.5285618128,0.5277958545,0.5270298308,0.5262637434,0.5254975942,0.5247313850,0.5239651175,0.5231987937,0.5224324152,0.5216659839,0.5208995016,0.5201329701,0.5193663911,0.5185997666,0.5178330984,0.5170663881,0.5162996376,0.5155328488,0.5147660234,0.5139991632,0.5132322701,0.5124653459,0.5116983923,0.5109314111,0.5101644042,0.5093973734,0.5086303205,0.5078632472,0.5070961554,0.5063290469,0.5055619236,0.5047947871,0.5040276393,0.5032604821,0.5024933172,0.5017261464,0.5009589715,0.5001917944,0.4994246169,0.4986574407,0.4978902676,0.4971230995,0.4963559382,0.4955887855,0.4948216431,0.4940545130,0.4932873968,0.4925202965,0.4917532138,0.4909861504,0.4902191083,0.4894520892,0.4886850950,0.4879181274,0.4871511882,0.4863842793,0.4856174024,0.4848505594,0.4840837521,0.4833169822,0.4825502516,0.4817835621,0.4810169155,0.4802503136,0.4794837582,0.4787172510,0.4779507940,0.4771843889,0.4764180375,0.4756517416,0.4748855030,0.4741193236,0.4733532050,0.4725871493,0.4718211580,0.4710552331,0.4702893764,0.4695235895,0.4687578745,0.4679922330,0.4672266668,0.4664611778,0.4656957678,0.4649304385,0.4641651918,0.4634000294,0.4626349532,0.4618699650,0.4611050665,0.4603402596,0.4595755461,0.4588109278,0.4580464064,0.4572819838,0.4565176617,0.4557534420,0.4549893265,0.4542253170,0.4534614152,0.4526976230,0.4519339421,0.4511703745,0.4504069217,0.4496435857,0.4488803683,0.4481172712,0.4473542963,0.4465914453,0.4458287200,0.4450661223,0.4443036539,0.4435413166,0.4427791123,0.4420170426,0.4412551095,0.4404933146,0.4397316599,0.4389701470,0.4382087778,0.4374475541,0.4366864777,0.4359255503,0.4351647737,0.4344041498,0.4336436803,0.4328833671,0.4321232118,0.4313632164,0.4306033825,0.4298437120,0.4290842067,0.4283248684,0.4275656987,0.4268066996,0.4260478728,0.4252892202,0.4245307434,0.4237724442,0.4230143246,0.4222563862,0.4214986308,0.4207410602,0.4199836762,0.4192264806,0.4184694751,0.4177126616,0.4169560419,0.4161996176,0.4154433906,0.4146873627,0.4139315356,0.4131759112,0.4124204911,0.4116652773,0.4109102714,0.4101554752,0.4094008906,0.4086465192,0.4078923629,0.4071384235,0.4063847027,0.4056312023,0.4048779240,0.4041248697,0.4033720411,0.4026194400,0.4018670681,0.4011149273,0.4003630193,0.3996113458,0.3988599087,0.3981087097,0.3973577506,0.3966070331,0.3958565590,0.3951063301,0.3943563481,0.3936066149,0.3928571321,0.3921079016,0.3913589251,0.3906102043,0.3898617411,0.3891135372,0.3883655943,0.3876179143,0.3868704988,0.3861233496,0.3853764686,0.3846298574,0.3838835178,0.3831374516,0.3823916605,0.3816461462,0.3809009106,0.3801559554,0.3794112824,0.3786668932,0.3779227897,0.3771789736,0.3764354466,0.3756922106,0.3749492671,0.3742066181,0.3734642653,0.3727222103,0.3719804550,0.3712390010,0.3704978502,0.3697570043,0.3690164650,0.3682762341,0.3675363133,0.3667967043,0.3660574089,0.3653184289,0.3645797659,0.3638414218,0.3631033982,0.3623656969,0.3616283196,0.3608912680,0.3601545440,0.3594181492,0.3586820854,0.3579463542,0.3572109575,0.3564758970,0.3557411743,0.3550067913,0.3542727496,0.3535390510,0.3528056972,0.3520726899,0.3513400309,0.3506077218,0.3498757645,0.3491441606,0.3484129119,0.3476820200,0.3469514867,0.3462213137,0.3454915028,0.3447620556,0.3440329739,0.3433042594,0.3425759138,0.3418479387,0.3411203361,0.3403931074,0.3396662545,0.3389397791,0.3382136829,0.3374879675,0.3367626347,0.3360376862,0.3353131238,0.3345889490,0.3338651637,0.3331417695,0.3324187681,0.3316961613,0.3309739506,0.3302521379,0.3295307249,0.3288097131,0.3280891044,0.3273689004,0.3266491028,0.3259297133,0.3252107337,0.3244921655,0.3237740105,0.3230562704,0.3223389469,0.3216220416,0.3209055563,0.3201894926,0.3194738522,0.3187586368,0.3180438481,0.3173294878,0.3166155575,0.3159020590,0.3151889939,0.3144763639,0.3137641706,0.3130524158,0.3123411011,0.3116302282,0.3109197987,0.3102098144,0.3095002769,0.3087911879,0.3080825491,0.3073743621,0.3066666285,0.3059593501,0.3052525286,0.3045461655,0.3038402626,0.3031348214,0.3024298438,0.3017253313,0.3010212855,0.3003177082,0.2996146010,0.2989119656,0.2982098036,0.2975081166,0.2968069063,0.2961061745,0.2954059226,0.2947061524,0.2940068655,0.2933080636,0.2926097483,0.2919119212,0.2912145840,0.2905177383,0.2898213858,0.2891255282,0.2884301670,0.2877353038,0.2870409404,0.2863470784,0.2856537193,0.2849608649,0.2842685167,0.2835766764,0.2828853456,0.2821945260,0.2815042191,0.2808144266,0.2801251501,0.2794363913,0.2787481518,0.2780604331,0.2773732369,0.2766865648,0.2760004185,0.2753147995,0.2746297095,0.2739451501,0.2732611228,0.2725776294,0.2718946713,0.2712122503,0.2705303679,0.2698490257,0.2691682254,0.2684879685,0.2678082566,0.2671290914,0.2664504744,0.2657724072,0.2650948915,0.2644179287,0.2637415206,0.2630656688,0.2623903747,0.2617156400,0.2610414663,0.2603678551,0.2596948081,0.2590223269,0.2583504130,0.2576790679,0.2570082934,0.2563380909,0.2556684620,0.2549994084,0.2543309316,0.2536630331,0.2529957146,0.2523289776,0.2516628236,0.2509972543,0.2503322712,0.2496678759,0.2490040700,0.2483408549,0.2476782323,0.2470162037,0.2463547708,0.2456939349,0.2450336978,0.2443740609,0.2437150259,0.2430565941,0.2423987673,0.2417415470,0.2410849346,0.2404289318,0.2397735401,0.2391187611,0.2384645962,0.2378110470,0.2371581151,0.2365058020,0.2358541092,0.2352030383,0.2345525907,0.2339027681,0.2332535720,0.2326050039,0.2319570652,0.2313097576,0.2306630826,0.2300170416,0.2293716363,0.2287268681,0.2280827385,0.2274392491,0.2267964013,0.2261541968,0.2255126369,0.2248717233,0.2242314574,0.2235918407,0.2229528747,0.2223145610,0.2216769010,0.2210398963,0.2204035483,0.2197678585,0.2191328285,0.2184984597,0.2178647536,0.2172317117,0.2165993356,0.2159676266,0.2153365864,0.2147062163,0.2140765178,0.2134474925,0.2128191418,0.2121914672,0.2115644701,0.2109381521,0.2103125147,0.2096875592,0.2090632872,0.2084397001,0.2078167994,0.2071945866,0.2065730632,0.2059522305,0.2053320901,0.2047126435,0.2040938920,0.2034758371,0.2028584803,0.2022418231,0.2016258669,0.2010106131,0.2003960632,0.1997822186,0.1991690809,0.1985566513,0.1979449315,0.1973339227,0.1967236265,0.1961140443,0.1955051775,0.1948970276,0.1942895960,0.1936828840,0.1930768932,0.1924716250,0.1918670808,0.1912632620,0.1906601701,0.1900578064,0.1894561724,0.1888552695,0.1882550991,0.1876556626,0.1870569615,0.1864589971,0.1858617708,0.1852652841,0.1846695384,0.1840745351,0.1834802755,0.1828867610,0.1822939932,0.1817019733,0.1811107027,0.1805201829,0.1799304152,0.1793414011,0.1787531419,0.1781656389,0.1775788936,0.1769929074,0.1764076816,0.1758232177,0.1752395169,0.1746565807,0.1740744105,0.1734930075,0.1729123732,0.1723325090,0.1717534162,0.1711750961,0.1705975502,0.1700207798,0.1694447862,0.1688695709,0.1682951351,0.1677214802,0.1671486076,0.1665765186,0.1660052146,0.1654346968,0.1648649667,0.1642960256,0.1637278749,0.1631605158,0.1625939497,0.1620281779,0.1614632018,0.1608990227,0.1603356420,0.1597730609,0.1592112807,0.1586503029,0.1580901287,0.1575307594,0.1569721964,0.1564144410,0.1558574944,0.1553013581,0.1547460332,0.1541915212,0.1536378232,0.1530849407,0.1525328750,0.1519816272,0.1514311988,0.1508815910,0.1503328050,0.1497848423,0.1492377041,0.1486913917,0.1481459063,0.1476012493,0.1470574219,0.1465144255,0.1459722612,0.1454309304,0.1448904343,0.1443507743,0.1438119515,0.1432739673,0.1427368229,0.1422005196,0.1416650587,0.1411304413,0.1405966689,0.1400637425,0.1395316635,0.1390004332,0.1384700527,0.1379405234,0.1374118464,0.1368840231,0.1363570546,0.1358309423,0.1353056872,0.1347812908,0.1342577542,0.1337350786,0.1332132653,0.1326923155,0.1321722304,0.1316530113,0.1311346594,0.1306171759,0.1301005620,0.1295848189,0.1290699479,0.1285559501,0.1280428268,0.1275305792,0.1270192085,0.1265087158,0.1259991025,0.1254903696,0.1249825184,0.1244755502,0.1239694659,0.1234642670,0.1229599545,0.1224565297,0.1219539937,0.1214523477,0.1209515929,0.1204517304,0.1199527615,0.1194546874,0.1189575091,0.1184612279,0.1179658450,0.1174713614,0.1169777784,0.1164850972,0.1159933188,0.1155024445,0.1150124754,0.1145234126,0.1140352573,0.1135480107,0.1130616739,0.1125762481,0.1120917343,0.1116081338,0.1111254476,0.1106436770,0.1101628230,0.1096828867,0.1092038694,0.1087257721,0.1082485959,0.1077723421,0.1072970116,0.1068226056,0.1063491253,0.1058765717,0.1054049460,0.1049342493,0.1044644827,0.1039956472,0.1035277440,0.1030607743,0.1025947390,0.1021296393,0.1016654763,0.1012022511,0.1007399647,0.1002786183,0.0998182129,0.0993587497,0.0989002297,0.0984426539,0.0979860236,0.0975303396,0.0970756032,0.0966218154,0.0961689772,0.0957170897,0.0952661540,0.0948161712,0.0943671422,0.0939190682,0.0934719503,0.0930257894,0.0925805866,0.0921363430,0.0916930595,0.0912507374,0.0908093775,0.0903689810,0.0899295489,0.0894910821,0.0890535818,0.0886170490,0.0881814846,0.0877468898,0.0873132655,0.0868806128,0.0864489327,0.0860182262,0.0855884943,0.0851597380,0.0847319584,0.0843051564,0.0838793330,0.0834544893,0.0830306263,0.0826077449,0.0821858461,0.0817649310,0.0813450005,0.0809260556,0.0805080974,0.0800911267,0.0796751446,0.0792601520,0.0788461499,0.0784331394,0.0780211213,0.0776100967,0.0772000665,0.0767910316,0.0763829931,0.0759759519,0.0755699090,0.0751648652,0.0747608217,0.0743577792,0.0739557388,0.0735547014,0.0731546680,0.0727556395,0.0723576168,0.0719606009,0.0715645927,0.0711695932,0.0707756032,0.0703826237,0.0699906557,0.0695997000,0.0692097575,0.0688208293,0.0684329161,0.0680460190,0.0676601388,0.0672752764,0.0668914328,0.0665086088,0.0661268053,0.0657460233,0.0653662637,0.0649875272,0.0646098149,0.0642331276,0.0638574663,0.0634828317,0.0631092247,0.0627366464,0.0623650974,0.0619945788,0.0616250913,0.0612566358,0.0608892133,0.0605228246,0.0601574704,0.0597931518,0.0594298696,0.0590676245,0.0587064175,0.0583462495,0.0579871211,0.0576290334,0.0572719872,0.0569159832,0.0565610224,0.0562071055,0.0558542334,0.0555024070,0.0551516270,0.0548018943,0.0544532097,0.0541055740,0.0537589881,0.0534134527,0.0530689687,0.0527255369,0.0523831581,0.0520418331,0.0517015627,0.0513623477,0.0510241889,0.0506870871,0.0503510430,0.0500160576,0.0496821316,0.0493492657,0.0490174607,0.0486867175,0.0483570368,0.0480284193,0.0477008659,0.0473743774,0.0470489544,0.0467245978,0.0464013083,0.0460790866,0.0457579337,0.0454378501,0.0451188367,0.0448008942,0.0444840233,0.0441682248,0.0438534995,0.0435398480,0.0432272712,0.0429157697,0.0426053443,0.0422959957,0.0419877247,0.0416805320,0.0413744182,0.0410693842,0.0407654306,0.0404625581,0.0401607675,0.0398600595,0.0395604348,0.0392618941,0.0389644380,0.0386680674,0.0383727828,0.0380785850,0.0377854747,0.0374934526,0.0372025193,0.0369126755,0.0366239220,0.0363362594,0.0360496883,0.0357642095,0.0354798237,0.0351965314,0.0349143334,0.0346332303,0.0343532228,0.0340743115,0.0337964972,0.0335197804,0.0332441618,0.0329696421,0.0326962219,0.0324239018,0.0321526825,0.0318825647,0.0316135489,0.0313456358,0.0310788260,0.0308131202,0.0305485190,0.0302850230,0.0300226328,0.0297613490,0.0295011723,0.0292421033,0.0289841425,0.0287272907,0.0284715483,0.0282169160,0.0279633944,0.0277109842,0.0274596857,0.0272094998,0.0269604270,0.0267124677,0.0264656228,0.0262198926,0.0259752778,0.0257317790,0.0254893968,0.0252481316,0.0250079842,0.0247689550,0.0245310446,0.0242942535,0.0240585824,0.0238240318,0.0235906023,0.0233582943,0.0231271084,0.0228970452,0.0226681052,0.0224402890,0.0222135971,0.0219880300,0.0217635883,0.0215402724,0.0213180830,0.0210970205,0.0208770854,0.0206582784,0.0204405998,0.0202240502,0.0200086301,0.0197943401,0.0195811805,0.0193691520,0.0191582550,0.0189484901,0.0187398576,0.0185323582,0.0183259922,0.0181207602,0.0179166627,0.0177137002,0.0175118730,0.0173111818,0.0171116269,0.0169132088,0.0167159281,0.0165197851,0.0163247804,0.0161309143,0.0159381874,0.0157466001,0.0155561529,0.0153668461,0.0151786803,0.0149916559,0.0148057733,0.0146210330,0.0144374353,0.0142549809,0.0140736699,0.0138935030,0.0137144805,0.0135366028,0.0133598704,0.0131842836,0.0130098429,0.0128365487,0.0126644015,0.0124934015,0.0123235492,0.0121548451,0.0119872894,0.0118208827,0.0116556253,0.0114915175,0.0113285598,0.0111667526,0.0110060962,0.0108465910,0.0106882374,0.0105310357,0.0103749864,0.0102200898,0.0100663462,0.0099137561,0.0097623197,0.0096120375,0.0094629098,0.0093149369,0.0091681193,0.0090224571,0.0088779509,0.0087346008,0.0085924073,0.0084513708,0.0083114914,0.0081727696,0.0080352057,0.0078988000,0.0077635528,0.0076294645,0.0074965353,0.0073647656,0.0072341557,0.0071047059,0.0069764164,0.0068492877,0.0067233200,0.0065985135,0.0064748687,0.0063523857,0.0062310649,0.0061109066,0.0059919110,0.0058740784,0.0057574091,0.0056419033,0.0055275614,0.0054143837,0.0053023703,0.0051915215,0.0050818376,0.0049733189,0.0048659656,0.0047597780,0.0046547563,0.0045509008,0.0044482116,0.0043466891,0.0042463336,0.0041471451,0.0040491240,0.0039522705,0.0038565848,0.0037620671,0.0036687177,0.0035765368,0.0034855246,0.0033956813,0.0033070072,0.0032195024,0.0031331671,0.0030480016,0.0029640060,0.0028811806,0.0027995255,0.0027190409,0.0026397271,0.0025615842,0.0024846123,0.0024088118,0.0023341826,0.0022607252,0.0021884395,0.0021173258,0.0020473842,0.0019786149,0.0019110181,0.0018445939,0.0017793425,0.0017152641,0.0016523587,0.0015906265,0.0015300677,0.0014706825,0.0014124709,0.0013554331,0.0012995693,0.0012448795,0.0011913638,0.0011390226,0.0010878557,0.0010378634,0.0009890458,0.0009414030,0.0008949351,0.0008496422,0.0008055245,0.0007625819,0.0007208147,0.0006802229,0.0006408067,0.0006025660,0.0005655011,0.0005296119,0.0004948987,0.0004613613,0.0004290001,0.0003978149,0.0003678059,0.0003389732,0.0003113168,0.0002848368,0.0002595332,0.0002354062,0.0002124557,0.0001906818,0.0001700847,0.0001506642,0.0001324205,0.0001153536,0.0000994636,0.0000847505,0.0000712143,0.0000588550,0.0000476727,0.0000376675,0.0000288392,0.0000211881,0.0000147140,0.0000094170,0.0000052970,0.0000023542,0.0000005886,0.0000000000 };
#endif

/* Populate interfaces */
lprand_t LPRand = { LOGISTIC_SEED_DEFAULT, LOGISTIC_X_DEFAULT, \
    LORENZ_TIMESTEP_DEFAULT, \
    LORENZ_X_DEFAULT, LORENZ_Y_DEFAULT, LORENZ_Z_DEFAULT, \
    LORENZ_A_DEFAULT, LORENZ_B_DEFAULT, LORENZ_C_DEFAULT, \
    rand_preseed, rand_seed, rand_base_stdlib, rand_base_logistic, \
    rand_base_lorenz, rand_base_lorenzX, rand_base_lorenzY, rand_base_lorenzZ, \
    rand_base_stdlib, rand_rand, rand_randint, rand_randbool, rand_choice };
lpmemorypool_factory_t LPMemoryPool = { 0, 0, 0, memorypool_init, memorypool_custom_init, memorypool_alloc, memorypool_custom_alloc, memorypool_free };
const lparray_factory_t LPArray = { create_array, create_array_from, destroy_array };
const lpbuffer_factory_t LPBuffer = { create_buffer, create_buffer_from_float, create_buffer_from_bytes, copy_buffer, clone_buffer, clear_buffer, split2_buffer, scale_buffer, min_buffer, max_buffer, mag_buffer, play_buffer, pan_stereo_buffer, mix_buffers, remix_buffer, clip_buffer, cut_buffer, cut_into_buffer, varispeed_buffer, resample_buffer, multiply_buffer, scalar_multiply_buffer, add_buffers, scalar_add_buffer, subtract_buffers, scalar_subtract_buffer, divide_buffers, scalar_divide_buffer, concat_buffers, buffers_are_equal, buffers_are_close, dub_buffer, dub_scalar, env_buffer, pad_buffer, taper_buffer, trim_buffer, fill_buffer, repeat_buffer, reverse_buffer, resize_buffer, plot_buffer, destroy_buffer };
const lpinterpolation_factory_t LPInterpolation = { interpolate_linear_pos, interpolate_linear_pos2, interpolate_linear, interpolate_linear_channel, interpolate_hermite_pos, interpolate_hermite };
const lpparam_factory_t LPParam = { param_create_from_float, param_create_from_int };
const lpwavetable_factory_t LPWavetable = { create_wavetable, create_wavetable_stack, destroy_wavetable };
const lpwindow_factory_t LPWindow = { create_window, create_window_stack, destroy_window };
const lpringbuffer_factory_t LPRingBuffer = { ringbuffer_create, ringbuffer_fill, ringbuffer_read, ringbuffer_readinto, ringbuffer_writefrom, ringbuffer_write, ringbuffer_readone, ringbuffer_writeone, ringbuffer_dub, ringbuffer_destroy };
const lpfx_factory_t LPFX = { read_skewed_buffer, fx_lpf1, fx_convolve, fx_norm, fx_fold, fx_limit, fx_crush };

/* Platform-specific random seed, called 
 * on program init (and on process pool init) 
 * from python or optionally elsewhere to 
 * seed random with nice bytes. */
void rand_preseed() {
#ifdef __linux__
    unsigned int * buffer;
    ssize_t bytes_read;
    size_t buffer_size;
    buffer_size = sizeof(unsigned int);
    buffer = LPMemoryPool.alloc(1, buffer_size);
    bytes_read = getrandom(buffer, buffer_size, 0);
    if(bytes_read > 0) srand(*buffer);
    free(buffer);
#endif
}

/* User rand seed */
void rand_seed(int value) {
    srand((unsigned int)value);
}

/* Default rand_base callback. 
 *
 * These base rand_base callbacks return 0-1 and 
 * are the basis of all other rand functions like 
 * choice and randint.
 *
 * They may be swapped out at runtime by setting 
 * LPRand.rand_base to the desired rand_base pointer;
 * */
lpfloat_t rand_base_stdlib(lpfloat_t low, lpfloat_t high) {
    return (rand()/(lpfloat_t)RAND_MAX) * (high-low) + low;
}

/* Logistic rand base. */
lpfloat_t rand_base_logistic(lpfloat_t low, lpfloat_t high) {
    LPRand.logistic_x = LPRand.logistic_seed * LPRand.logistic_x * (1.f - LPRand.logistic_x);
    return LPRand.logistic_x * (high-low) + low;
}

/* The three Lorenz attractor implementations (lorenzX, lorenzY, lorenzZ) 
 * were lightly adapted with permission from Greg Cope's helpful overview: 
 *      https://www.algosome.com/articles/lorenz-attractor-programming-code.html
 * Please consider those routines to be included here under an MIT license.
 */
lpfloat_t lorenzX(lpfloat_t low, lpfloat_t high) {
    LPRand.lorenz_x = LPRand.lorenz_x + LPRand.lorenz_timestep * LPRand.lorenz_a * (LPRand.lorenz_y - LPRand.lorenz_x);
    return LPRand.lorenz_x * (high-low) + low;
}

lpfloat_t lorenzY(lpfloat_t low, lpfloat_t high) {
    LPRand.lorenz_y = LPRand.lorenz_y + LPRand.lorenz_timestep * (LPRand.lorenz_x * (LPRand.lorenz_b - LPRand.lorenz_z) - LPRand.lorenz_y);
    return LPRand.lorenz_y * (high-low) + low;
}

lpfloat_t lorenzZ(lpfloat_t low, lpfloat_t high) {
    LPRand.lorenz_z = LPRand.lorenz_z + LPRand.lorenz_timestep * (LPRand.lorenz_x * LPRand.lorenz_y - LPRand.lorenz_c * LPRand.lorenz_z);
    return LPRand.lorenz_z * (high-low) + low;
}

lpfloat_t rand_base_lorenzX(lpfloat_t low, lpfloat_t high) {
    lpfloat_t x;
    x = lorenzX(low, high);
    lorenzY(low, high);
    lorenzZ(low, high);
    return x;
}

lpfloat_t rand_base_lorenzY(lpfloat_t low, lpfloat_t high) {
    lpfloat_t y;
    lorenzX(low, high);
    y = lorenzY(low, high);
    lorenzZ(low, high);
    return y;
}

lpfloat_t rand_base_lorenzZ(lpfloat_t low, lpfloat_t high) {
    lpfloat_t z;
    lorenzX(low, high);
    lorenzY(low, high);
    z = lorenzZ(low, high);
    return z;
}

lpfloat_t rand_base_lorenz(lpfloat_t low, lpfloat_t high) {
    lpfloat_t x, y, z, val;
    x = lorenzX(0, 1);
    y = lorenzY(0, 1);
    z = lorenzZ(0, 1);
    val = x * y * z;
    while(val > high) {
        val -= (high-low);
    }
    while(val < low) {
        val += (high-low);
    }

    return val;
}

lpfloat_t rand_rand(lpfloat_t low, lpfloat_t high) {
    return LPRand.rand_base(low, high);
}

int rand_randint(int low, int high) {
    float diff, tmp;

    tmp = (float)rand_rand((lpfloat_t)low, (lpfloat_t)high);
    diff = (int)tmp - tmp;

    if(diff >= 0.5f) {
        return (int)ceil(tmp);
    } else {
        return (int)floor(tmp);
    }
}

int rand_randbool(void) {
    return rand_randint(0, 1);
}

int rand_choice(int numchoices) {
    assert(numchoices > 0);
    if(numchoices == 1) return 0;
    return rand_randint(0, numchoices);
}

lparray_t * create_array(size_t length) {
    size_t i = 0;
    lparray_t * array = (lparray_t*)LPMemoryPool.alloc(1, sizeof(lparray_t));
    array->data = (int*)LPMemoryPool.alloc(length, sizeof(int));
    array->length = length;
    for(i=0; i < array->length; i++) {
        array->data[i] = 0;
    }
    array->phase = 0.f;
    return array;
}

lparray_t * create_array_from(int numvalues, ...) {
    va_list vl;
    lparray_t * array;
    int i;

    va_start(vl, numvalues);

    array = (lparray_t*)LPMemoryPool.alloc(1, sizeof(lparray_t));
    array->data = (int*)LPMemoryPool.alloc(numvalues, sizeof(int));

    for(i=0; i < numvalues; i++) {
        array->data[i] = va_arg(vl, int);
    }

    va_end(vl);

    return array;
}

void destroy_array(lparray_t * array) {
    if(array != NULL) {
        LPMemoryPool.free(array->data);
        LPMemoryPool.free(array);
    }
}

/* Buffer
 * */
lpbuffer_t * create_buffer(size_t length, int channels, int samplerate) {
    lpbuffer_t * buf;
    size_t bufsize = sizeof(lpbuffer_t) + (length * channels * sizeof(lpfloat_t));

    buf = (lpbuffer_t*)LPMemoryPool.alloc(1, bufsize);
    if(buf == NULL) {
        fprintf(stderr, "Could not alloc memory for buffer struct\n");
        return NULL;
    }

    memset(buf, 0, bufsize);
    buf->channels = channels;
    buf->length = length;
    buf->samplerate = samplerate;
    buf->boundry = length-1;
    buf->range = length;
    return buf;
}

lpbuffer_t * create_buffer_from_float(lpfloat_t value, size_t length, int channels, int samplerate) {
    size_t i;
    int c;
    lpbuffer_t * buf;
    buf = create_buffer(length, channels, samplerate);
    for(i=0; i < length; i++) {
        for(c=0; c < channels; c++) {
            buf->data[i * channels + c] = value;
        }
    }
    return buf;
}

lpbuffer_t * create_buffer_from_bytes(char * bytes, size_t length, int channels, int samplerate) {
    size_t i;
    char val = 0;
    lpbuffer_t * buf;
    buf = create_buffer(length, channels, samplerate);
    for(i=0; i < buf->length * channels; i++) {
        val = (int)bytes[i];
        buf->data[i] = (float)(val / CHAR_MAX);
    }

    return buf;
}

/*
void stack2_buffer(lpbuffer_t * src, lpbuffer_t * a, lpbuffer_t * b) {
    size_t i;

    assert(src->channels == 2);

    a = LPBuffer.create(src->length, 1, src->samplerate);
    b = LPBuffer.create(src->length, 1, src->samplerate);

    for(i=0; i < src->length; i++) {
        a->data[i] = src->data[i * 2];        
        a->data[i * 2] = src->data[i * 2 + 1];        
    }
}
*/


void split2_buffer(lpbuffer_t * src, lpbuffer_t * a, lpbuffer_t * b) {
    size_t i;

    assert(src->channels == 2);
    assert(src->length == a->length);
    assert(src->length == b->length);

    for(i=0; i < src->length; i++) {
        a->data[i] = src->data[i * 2];        
        b->data[i] = src->data[i * 2 + 1];        
    }
}

void copy_buffer(lpbuffer_t * src, lpbuffer_t * dest) {
    size_t i;
    int c;

    assert(src->length == dest->length);
    assert(src->channels == dest->channels);

    for(i=0; i < src->length; i++) {
        for(c=0; c < src->channels; c++) {
            dest->data[i * src->channels + c] = src->data[i * src->channels + c];
        }
    }
}

lpbuffer_t * clone_buffer(lpbuffer_t * src) {
    size_t i;
    int c;

    lpbuffer_t * out = create_buffer(src->length, src->channels, src->samplerate);

    for(i=0; i < src->length; i++) {
        for(c=0; c < src->channels; c++) {
            out->data[i * src->channels + c] = src->data[i * src->channels + c];
        }
    }

    return out;
}


void clear_buffer(lpbuffer_t * buf) {
    size_t i;
    int c;

    for(i=0; i < buf->length; i++) {
        for(c=0; c < buf->channels; c++) {
            buf->data[i * buf->channels + c] = 0.f;
        }
    }
}

void scale_buffer(lpbuffer_t * buf, lpfloat_t from_min, lpfloat_t from_max, lpfloat_t to_min, lpfloat_t to_max) {
    size_t i;
    int c, idx;
    lpfloat_t from_diff, to_diff;

    to_diff = to_max - to_min;;
    from_diff = from_max - from_min;;

    /* Maybe this is valid? It's weird to "scale" 
     * a buffer filled with one value, but I guess 
     * that's a case we should support...
     * Ideally we'll figure out how to get rid of that 
     * repeating divide and use an approach that supports 
     * this case.
     * Anyway: TODO handle this better?
     */
    assert(from_diff != 0);

    for(i=0; i < buf->length; i++) {
        for(c=0; c < buf->channels; c++) {
            idx = i * buf->channels + c;
            buf->data[idx] = ((buf->data[idx] - from_min) / from_diff) * to_diff + to_min;
        }
    }
}

lpfloat_t min_buffer(lpbuffer_t * buf) {
    lpfloat_t out = 0.f;
    size_t i;
    int c;

    for(i=0; i < buf->length; i++) {
        for(c=0; c < buf->channels; c++) {
            if(i==0 && c==0) {
                out = buf->data[i * buf->channels + c];
                continue;
            }
            out = fmin(buf->data[i * buf->channels + c], out);
        }
    }
    return out;
}

lpfloat_t max_buffer(lpbuffer_t * buf) {
    lpfloat_t out = 0.f;
    size_t i;
    int c;

    for(i=0; i < buf->length; i++) {
        for(c=0; c < buf->channels; c++) {
            if(i==0 && c==0) {
                out = buf->data[i * buf->channels + c];
                continue;
            }
            out = fmax(buf->data[i * buf->channels + c], out);
        }
    }
    return out;
}

lpfloat_t mag_buffer(lpbuffer_t * buf) {
    lpfloat_t out = 0.f;
    size_t i;
    int c;

    for(i=0; i < buf->length; i++) {
        for(c=0; c < buf->channels; c++) {
            out = fmax(fabs(buf->data[i * buf->channels + c]), out);
        }
    }
    return out;
}

void pan_stereo_constant(lpfloat_t pos, lpfloat_t left_in, lpfloat_t right_in, lpfloat_t * left_out, lpfloat_t * right_out) {
    *left_out = left_in * (lpfloat_t)sqrt(1.f - pos);
    *right_out = right_in * (lpfloat_t)sqrt(pos);
}

void pan_stereo_linear(lpfloat_t pos, lpfloat_t left_in, lpfloat_t right_in, lpfloat_t * left_out, lpfloat_t * right_out) {
    *left_out = left_in * (1.f - pos);
    *right_out = right_in * pos;
}

void pan_stereo_sine(lpfloat_t pos, lpfloat_t left_in, lpfloat_t right_in, lpfloat_t * left_out, lpfloat_t * right_out) {
    *left_out = left_in * (lpfloat_t)sin(pos * (lpfloat_t)HALFPI);
    *right_out = right_in * (lpfloat_t)cos(pos * (lpfloat_t)HALFPI);
}

void pan_stereo_gogins(lpfloat_t pos, lpfloat_t left_in, lpfloat_t right_in, lpfloat_t * left_out, lpfloat_t * right_out) {
    *left_out = left_in * (lpfloat_t)sin((pos + 0.5f) * (lpfloat_t)HALFPI);
    *right_out = right_in * (lpfloat_t)cos((pos + 0.5f) * (lpfloat_t)HALFPI);
}

void pan_stereo_buffer(lpbuffer_t * buf, lpbuffer_t * pos, int method) {
    void (*handler)(lpfloat_t, lpfloat_t, lpfloat_t, lpfloat_t *, lpfloat_t *);
    lpfloat_t _pos;
    size_t i;

    assert(buf->channels == 2);

    if(method == PANMETHOD_CONSTANT) {
        handler = &pan_stereo_constant;
    } else if(method == PANMETHOD_LINEAR) {
        handler = &pan_stereo_linear;
    } else if(method == PANMETHOD_SINE) {
        handler = &pan_stereo_sine;
    } else if(method == PANMETHOD_GOGINS) {
        handler = &pan_stereo_gogins;
    } else {
        handler = &pan_stereo_constant;
    }

    for(i=0; i < buf->length; i++) {
        _pos = interpolate_linear_pos(pos, (lpfloat_t)i/buf->length);
        handler(_pos, buf->data[i*2], buf->data[i*2+1], &buf->data[i*2], &buf->data[i*2+1]);
    }
}

lpfloat_t play_buffer(lpbuffer_t * buf, lpfloat_t speed) {
    lpfloat_t phase_inc, value;
    phase_inc = 1.f / (buf->length * (1.f / speed));
    value = interpolate_linear_pos(buf, buf->phase);
    buf->phase += phase_inc;
    return value;
}

lpbuffer_t * varispeed_buffer(lpbuffer_t * buf, lpbuffer_t * speed) {
    lpbuffer_t * out;
    lpbuffer_t * trimmed;
    lpfloat_t pos, phase_inc, phase, _speed, minspeed;
    size_t i, length;
    int c;

    minspeed = fmax(LPVSPEED_MIN, min_buffer(speed));
    length = (size_t)(buf->length * (1.f/minspeed));

    phase = 0.f;
    phase_inc = (1.f/buf->length) * (buf->length-1);

    assert(length > 1);

    out = create_buffer(length, buf->channels, buf->samplerate);
    for(i=0; i < length; i++) {
        pos = (lpfloat_t)i / length;

        for(c=0; c < buf->channels; c++) {
            out->data[i * buf->channels + c] = interpolate_linear_channel(buf, phase, c);
        }

        _speed = interpolate_linear_pos(speed, pos);
        phase += phase_inc * _speed;
        if(phase >= buf->length) break;
    }

    trimmed = cut_buffer(out, 0, i);
    free(out);
    return trimmed;
}

lpbuffer_t * resample_buffer(lpbuffer_t * buf, size_t length) {
    lpbuffer_t * out;
    lpfloat_t pos;
    size_t i;
    int c;

    assert(length > 1);
    out = create_buffer(length, buf->channels, buf->samplerate);
    for(i=0; i < length; i++) {
        pos = (lpfloat_t)i/length;
        for(c=0; c < buf->channels; c++) {
            out->data[i * buf->channels + c] = interpolate_linear_channel(buf, pos * buf->length, c);
        }
    }

    return out;
}

void multiply_buffer(lpbuffer_t * a, lpbuffer_t * b) {
    size_t length, i;
    int c, j;
    length = (a->length <= b->length) ? a->length : b->length;
    for(i=0; i < length; i++) {
        for(c=0; c < a->channels; c++) {
            j = c % b->channels;
            a->data[i * a->channels + c] *= b->data[i * b->channels + j];
        }
    }
}

void scalar_multiply_buffer(lpbuffer_t * a, lpfloat_t b) {
    size_t i;
    int c;
    for(i=0; i < a->length; i++) {
        for(c=0; c < a->channels; c++) {
            a->data[i * a->channels + c] *= b;
        }
    }
}

lpbuffer_t * concat_buffers(lpbuffer_t * a, lpbuffer_t * b) {
    size_t length, i;
    int c, channels;
    lpbuffer_t * out;

    length = a->length + b->length;
    channels = a->channels;
    out = create_buffer(length, channels, a->samplerate);

    for(i=0; i < a->length; i++) {
        for(c=0; c < channels; c++) {
            out->data[i * channels + c] = a->data[i * channels + c];
        }
    }

    for(i=a->length; i < length; i++) {
        for(c=0; c < channels; c++) {
            out->data[i * channels + c] = b->data[(i-a->length) * channels + c];
        }
    }

    return out;
}

void add_buffers(lpbuffer_t * a, lpbuffer_t * b) {
    size_t length, i;
    int c, j;
    length = (a->length <= b->length) ? a->length : b->length;
    for(i=0; i < length; i++) {
        for(c=0; c < a->channels; c++) {
            j = c % b->channels;
            a->data[i * a->channels + c] += b->data[i * b->channels + j];
        }
    }
}

void scalar_add_buffer(lpbuffer_t * a, lpfloat_t b) {
    size_t i;
    int c;
    for(i=0; i < a->length; i++) {
        for(c=0; c < a->channels; c++) {
            a->data[i * a->channels + c] += b;
        }
    }
}

void subtract_buffers(lpbuffer_t * a, lpbuffer_t * b) {
    size_t length, i;
    int c, j;
    length = (a->length <= b->length) ? a->length : b->length;
    for(i=0; i < length; i++) {
        for(c=0; c < a->channels; c++) {
            j = c % b->channels;
            a->data[i * a->channels + c] -= b->data[i * b->channels + j];
        }
    }
}

void scalar_subtract_buffer(lpbuffer_t * a, lpfloat_t b) {
    size_t i;
    int c;
    for(i=0; i < a->length; i++) {
        for(c=0; c < a->channels; c++) {
            a->data[i * a->channels + c] -= b;
        }
    }
}

void divide_buffers(lpbuffer_t * a, lpbuffer_t * b) {
    size_t length, i;
    int c, j;
    length = (a->length <= b->length) ? a->length : b->length;
    for(i=0; i < length; i++) {
        for(c=0; c < a->channels; c++) {
            j = c % b->channels;
            if(b->data[i * b->channels + j] == 0) {
                a->data[i * a->channels + c] = 0.f;
            } else {
                a->data[i * a->channels + c] /= b->data[i * b->channels + j];
            }
        }
    }
}

void scalar_divide_buffer(lpbuffer_t * a, lpfloat_t b) {
    size_t i;
    int c;
    if(b == 0) {
        for(i=0; i < a->length; i++) {
            for(c=0; c < a->channels; c++) {
                a->data[i * a->channels + c] = 0.f;
            }
        }
    } else {
        for(i=0; i < a->length; i++) {
            for(c=0; c < a->channels; c++) {
                a->data[i * a->channels + c] /= b;
            }
        }
    }
}

int buffers_are_equal(lpbuffer_t * a, lpbuffer_t * b) {
    size_t i;
    int c;
    if(a->length != b->length) return 0;
    if(a->channels != b->channels) return 0;
    for(i=0; i < a->length; i++) {
        for(c=0; c < a->channels; c++) {
            if(a->data[i * a->channels + c] != b->data[i * a->channels + c]) return 0;
        }
    }
    return 1;
}

int buffers_are_close(lpbuffer_t * a, lpbuffer_t * b, int d) {
    size_t i;
    int c;
    long atmp, btmp;
    if(a->length != b->length) return 0;
    if(a->channels != b->channels) return 0;
    for(i=0; i < a->length; i++) {
        for(c=0; c < a->channels; c++) {
            atmp = floor(a->data[i * a->channels + c] * d);
            btmp = floor(b->data[i * a->channels + c] * d);
            if(atmp != btmp) return 0;
        }
    }
    return 1;
}


void env_buffer(lpbuffer_t * buf, lpbuffer_t * env) {
    lpfloat_t pos, value;
    size_t i;
    int c;

    assert(env->length > 0);
    assert(env->channels == 1);

    for(i=0; i < buf->length; i++) {
        pos = (lpfloat_t)i / buf->length;
        value = interpolate_linear_pos(env, pos);
        for(c=0; c < buf->channels; c++) {
            buf->data[i * buf->channels + c] *= value;
        }
    }
}

lpbuffer_t * pad_buffer(lpbuffer_t * buf, size_t before, size_t after) {
    size_t length, i;
    int c;
    lpbuffer_t * out;

    length = buf->length + before + after;
    out = LPBuffer.create(length, buf->channels, buf->samplerate);

    for(i=0; i < buf->length; i++) {
        for(c=0; c < out->channels; c++) {
            out->data[(i+before) * out->channels + c] = buf->data[i * out->channels + c];
        }
    }

    return out;
}

lpfloat_t _sum_abs_frame(lpbuffer_t * buf, size_t pos) {
    int c;
    lpfloat_t current;
    current = 0;
    for(c=0; c < buf->channels; c++) {
        current += buf->data[pos * buf->channels + c];
    }

    current /= (lpfloat_t)buf->channels;
    current = fabs(current);

    return current; 
}

void taper_buffer(lpbuffer_t * buf, size_t start, size_t end) {
    lpfloat_t frac, a, b, phase, sample, mul;
    size_t i, offset, winlength;
    int c, hi;

    assert(start <= buf->length);
    assert(end <= buf->length);

    winlength = HANN_WINDOW_SIZE / 2;

    start = (start > buf->length) ? buf->length : start;
    end = (end > buf->length) ? buf->length : end;

    if(start > 0) {
        for(i=0; i < start; i++) {
            phase = ((lpfloat_t)i / start) * (winlength-1);
            frac = phase - (int)phase;
            hi = (int)phase;
            a = LPHANN_WINDOW[hi];
            b = LPHANN_WINDOW[hi+1];
            mul = (1.0f - frac) * a + (frac * b);

            for(c=0; c < buf->channels; c++) {
                sample = mul * buf->data[i * buf->channels + c];
                buf->data[i * buf->channels + c] = sample;
            }
        }
    }

    if(end > 0) {
        for(i=0; i < end; i++) {
            offset = buf->length - end;
            phase = ((lpfloat_t)i / end) * (winlength-1);
            frac = phase - (int)phase;
            hi = (int)phase + winlength;
            a = LPHANN_WINDOW[hi];
            b = LPHANN_WINDOW[hi+1];
            mul = (1.0f - frac) * a + (frac * b);

            for(c=0; c < buf->channels; c++) {
                sample = mul * buf->data[(offset + i) * buf->channels + c];
                buf->data[(offset + i) * buf->channels + c] = sample;
            }
        }
    }
}

lpbuffer_t * trim_buffer(lpbuffer_t * buf, size_t start, size_t end, lpfloat_t threshold, int window) {
    size_t boundry, trimend, trimstart, length, i;
    lpbuffer_t * out;
    lpfloat_t current;
    int c, hits;

    boundry = buf->length - 1;
    trimend = boundry;
    trimstart = 0;
    current = 0.f;
    hits = 0;

    if(end==1) {
        while(1) {
            current = _sum_abs_frame(buf, trimend);
            if(current > threshold) hits += 1;
            trimend -= 1;
            if(trimend <= 0 || hits >= window) break;
        }
    }

    if(start==1) {
        hits = 0;
        while(1) {
            current = _sum_abs_frame(buf, trimstart);
            if(current > threshold) hits += 1;
            trimstart += 1;
            if(trimstart >= boundry || hits >= window) break;
        }
    }

    length = trimend - trimstart;
    out = LPBuffer.create(length, buf->channels, buf->samplerate);

    for(i=0; i < length; i++) {
        for(c=0; c < buf->channels; c++) {
            out->data[i * buf->channels + c] = buf->data[(trimstart + i) * buf->channels + c];
        }
    }

    return out;
}

void print_pixels(int * pixels, int width, int height) {
    int x, y;
    for(y=0; y < height; y++) {
        for(x=0; x < width; x++) {
            fprintf(stdout, "%d", pixels[x * PIXEL_HEIGHT + y]);
        }
        fprintf(stdout, "\n");
    }
}

wchar_t get_grid_char(int pixels[BRAILLE_WIDTH * BRAILLE_HEIGHT]) {
    int i, r;
    int map[BRAILLE_WIDTH * BRAILLE_HEIGHT] = {0,2,4,1,3,5,6,7};

    /* Braille dots are indexed like this:
     *   1 4
     *   2 5
     *   3 6 
     *   7 8
     *
     * Mapped to pixel inputs:
     *
     *   pixels:   0  1  2  3  4  5  6  7
     *   braille:  0  2  4  1  3  5  6  7
     *   byte idx: 1  2  4  8  16 32 64 128
     */
    //print_pixels(pixels, BRAILLE_WIDTH, BRAILLE_HEIGHT);
    r = 0;
    fprintf(stderr, "BEG\n");
    for(i=0; i < BRAILLE_WIDTH * BRAILLE_HEIGHT; i++) {
        fprintf(stderr, "pixels[map[%d]]=%d pixels[%d]=%d\n", i, pixels[map[i]], i, pixels[i]);
        if(pixels[map[i]] == 1) {
            fprintf(stderr, "  map[%d]: %d exp2(%d): %d\n", i, map[i], i, (int)exp2(i));
            r += (int)exp2(i);
        }
    }
    fprintf(stderr, "END\n");

    return (wchar_t)(GRID_EMPTY + r);
}

void copy_pixels_to_block(int * pixels, int offset_x, int offset_y, int * block, int width, int height) {
    int x, y, px, py;
    for(x=0; x < width; x++) {
        for(y=0; y < height; y++) {
            px = x + offset_x;
            py = y + offset_y;
            block[x * height + y] = pixels[px * PIXEL_HEIGHT + py];
        }
    }
}

void plot_buffer(lpbuffer_t * buf) {
    size_t i, pos, blocksize;
    int c;
    int color;
    int px, py1, py2, py;
    int cx, cy;
    float sample, peak, low;
    wchar_t w;

    int pixel_block[BRAILLE_WIDTH * BRAILLE_HEIGHT] = {0};
    int pixels[PIXEL_WIDTH * PIXEL_HEIGHT] = {0};

    blocksize = (size_t)(buf->length / (float)PIXEL_WIDTH);

    pos = 0;
    px = 0;
    py1 = 0;
    py2 = 0;

    /* Trace a temporary pixel buffer:
     *     1s at peaks and lows, 0s elsewhere.
     *
     * Width is PIXEL_WIDTH 
     *     where each pixel is a 1 at the averaged peaks and 
     *     lows of the block size computed from the buffer length.
     *
     * Height is PIXEL_HEIGHT
     *     with buffer values scaled from 
     *     a -1.f to 1.f domain to 
     *     a range of 0 to PIXEL_HEIGHT pixels.
     */
    while(pos <= buf->length-blocksize) {
        peak = 0;
        low = 0;

        for(i=0; i < blocksize; i++) {
            sample = 0.f;
            for(c=0; c < buf->channels; c++) {
                sample += (float)buf->data[(i+pos) * buf->channels + c];
            }

            peak = fmax(peak, sample);
            low = fmin(low, sample);
        }

        peak = fmin(1.f, (peak+1.f)/2.f);
        low = fmax(0.f, (low+1.f)/2.f);

        py1 = (int)(peak * PIXEL_HEIGHT);
        py2 = (int)(low * PIXEL_HEIGHT);
        pixels[px * PIXEL_HEIGHT + py1] = 1;
        pixels[px * PIXEL_HEIGHT + py2] = 1;

        pos += blocksize;
        px += 1;

        assert(px <= PIXEL_WIDTH);
    }


    print_pixels(pixels, PIXEL_WIDTH, PIXEL_HEIGHT);
    /* for each braille char row */
    for(cy=0; cy < PLOT_HEIGHT; cy++) {
        /* for each braille char column in this row */
        py = cy * BRAILLE_HEIGHT;
        for(cx=0; cx < PLOT_WIDTH; cx++) {
            px = cx * BRAILLE_WIDTH;

            copy_pixels_to_block(pixels, px, py, pixel_block, BRAILLE_WIDTH, BRAILLE_HEIGHT);
            fprintf(stderr, "\n\npixel_block\n");
            //print_pixels(pixel_block, BRAILLE_WIDTH, BRAILLE_HEIGHT);
            color = 255; // FIXME do something fun (or useful?)
            printf("\033[38;5;%dm", color);
            w = get_grid_char(pixel_block);
            printf("%lc", w);
            fprintf(stderr, "GOT %lc\n\n", w);
        } 
        printf("\n");
    }
    printf("\033[0m");
    printf("\n\n");

}

void dub_buffer(lpbuffer_t * a, lpbuffer_t * b, size_t start) {
    size_t i;
    int c, j;
    lpfloat_t sample;

    assert(start + b->length <= a->length);
    assert(b->length <= a->length);
    assert(a->channels == b->channels);

    for(i=0; i < b->length; i++) {
        for(c=0; c < a->channels; c++) {
            j = c % b->channels;
            sample = b->data[i * b->channels + j];
            a->data[(i+start) * a->channels + c] += sample;
        }
    }
}

void dub_scalar(lpbuffer_t * a, lpfloat_t val, size_t start) {
    int c;

    assert(start < a->length);
    for(c=0; c < a->channels; c++) {
        a->data[start * a->channels + c] += val;
    }
}

void cut_into_buffer(lpbuffer_t * buf, lpbuffer_t * out, size_t start, size_t length) {
    size_t i, writelength;
    int c;

    /* FIXME support zero-length buffers */
    assert(length > 0);

    if(start < buf->length) {
        writelength = buf->length - start;
        writelength = (writelength > length) ? length : writelength;
        for(i=0; i < writelength; i++) {
            for(c=0; c < buf->channels; c++) {
                out->data[i * buf->channels + c] = buf->data[(i+start) * buf->channels + c];
            }
        }
    }
}

void clip_buffer(lpbuffer_t * buf, lpfloat_t minval, lpfloat_t maxval) {
    size_t i, elements;
    elements = buf->length * buf->channels;
    for(i=0; i < elements; i++) {
        buf->data[i] = fmin(fmax(buf->data[i], minval), maxval);
    }
}

lpbuffer_t * cut_buffer(lpbuffer_t * buf, size_t start, size_t length) {
    lpbuffer_t * out;

    /* FIXME support zero-length buffers */
    assert(length > 0);

    out = LPBuffer.create(length, buf->channels, buf->samplerate);
    cut_into_buffer(buf, out, start, length);
    return out;
}

lpbuffer_t * mix_buffers(lpbuffer_t * a, lpbuffer_t * b) {
    int max_channels, max_samplerate, c;
    size_t i;
    lpbuffer_t * out;
    lpbuffer_t * longest;
    lpbuffer_t * shortest;

    if(a->length >= b->length) {
        longest=a; shortest=b;
    } else {
        longest=b; shortest=a;
    }

    max_channels = (a->channels >= b->channels) ? a->channels : b->channels;
    max_samplerate = (a->samplerate >= b->samplerate) ? a->samplerate : b->samplerate;
    out = LPBuffer.create(longest->length, max_channels, max_samplerate);

    for(i=0; i < longest->length; i++) {
        for(c=0; c < max_channels; c++) {
            out->data[i * max_channels + c] += longest->data[i * max_channels + c];
        }
    }

    for(i=0; i < shortest->length; i++) {
        for(c=0; c < max_channels; c++) {
            out->data[i * max_channels + c] += shortest->data[i * max_channels + c];
        }
    }

    return out;
}

lpbuffer_t * remix_buffer(lpbuffer_t * buf, int channels) {
    size_t i;
    int c, ci;
    lpbuffer_t * newbuf;
    lpfloat_t sample, phase, frac, a, b;

    newbuf = create_buffer(buf->length, channels, buf->samplerate);

    if(channels <= 1) {
        for(i=0; i < buf->length; i++) {
            for(c=0; c < buf->channels; c++) {
                newbuf->data[i] += buf->data[i * buf->channels + c];
            }
        }
    } else {
        for(i=0; i < buf->length; i++) {
            for(c=0; c < channels; c++) {
                phase = (c / (lpfloat_t)(channels-1)) * buf->channels;
                ci = (int)phase;
                frac = phase - ci;
                a = buf->data[i * buf->channels + ci];
                b = buf->data[i * buf->channels + ci+1];
                sample = (1.0f - frac) * a + (frac * b);
                newbuf->data[i * channels + c] = sample;
            }
        }
    }

    return newbuf;
}

lpbuffer_t * remix_buffer_to_channels(lpbuffer_t * buf, int * channels, int num_channels) {
    size_t i;
    int c;
    lpbuffer_t * newbuf;

    assert(num_channels > 0);

    newbuf = create_buffer(buf->length, num_channels, buf->samplerate);

    for(i=0; i < buf->length; i++) {
        for(c=0; c < num_channels; c++) {
            if((channels[c]-1) >= buf->channels) continue;
            newbuf->data[i * num_channels + c] = buf->data[i * buf->channels + (channels[c]-1)];
        }
    }

    return newbuf;
}

lpbuffer_t * fill_buffer(lpbuffer_t * buf, size_t length) {
    size_t i, j;
    int c;
    lpbuffer_t * out;
    out = create_buffer(length, buf->channels, buf->samplerate);

    for(i=0; i < length; i++) {
        j = i % buf->length;
        for(c=0; c < out->channels; c++) {
            out->data[i * out->channels + c] = buf->data[j * out->channels + c];
        }
    }

    return out;
}

lpbuffer_t * repeat_buffer(lpbuffer_t * buf, size_t repeats) {
    size_t length, pos, i;
    lpbuffer_t * out;
    length = buf->length * repeats;
    out = create_buffer(length, buf->channels, buf->samplerate);

    pos = 0;
    for(i=0; i < repeats; i++) {
        dub_buffer(out, buf, pos);
        pos += buf->length;
    }

    return out;
}

lpbuffer_t * reverse_buffer(lpbuffer_t * buf) {
    size_t i, r;
    int c;
    lpbuffer_t * out;
    out = create_buffer(buf->length, buf->channels, buf->samplerate);

    for(c=0; c < buf->channels; c++) {
        for(i=0; i < buf->length; i++) {
            r = buf->length - i - 1;
            out->data[r * buf->channels + c] = buf->data[i * buf->channels + c];
        }
    }

    return out;
}


lpbuffer_t * resize_buffer(lpbuffer_t * buf, size_t length) {
    size_t i;
    int c;
    lpbuffer_t * newbuf;

    newbuf = create_buffer(length, buf->channels, buf->samplerate);

    for(i=0; i < length; i++) {
        if(i >= buf->length) break;
        for(c=0; c < buf->channels; c++) {
            newbuf->data[i * buf->channels + c] = buf->data[i * buf->channels + c];    
        }
    }

    destroy_buffer(buf);
    return newbuf;
}

void destroy_buffer(lpbuffer_t * buf) {
    if(buf != NULL) {
        LPMemoryPool.free(buf);
    }
}

/* Basic FX / waveshaping
 */
lpfloat_t read_skewed_buffer(lpfloat_t freq, lpbuffer_t * buf, lpfloat_t phase, lpfloat_t skew) {
    lpfloat_t warp, m, pos;

    m = 0.5f - skew;

    pos = phase / buf->length;
    if(phase < skew) {
        warp = m * (pos / skew);
    } else {
        warp = m * ((1.f-pos) / (1.f-skew));
    }

    return LPInterpolation.linear(buf, (phase + (warp * buf->length)) * freq);
}

lpfloat_t fx_lpf1(lpfloat_t x, lpfloat_t * y, lpfloat_t cutoff, lpfloat_t samplerate) {
    lpfloat_t gamma = 1.f - (lpfloat_t)exp(-(2.f * (lpfloat_t)PI) * (cutoff/samplerate));
    *y = (1.f - gamma) * (*y) + gamma * x;
    return *y;
}

lpfloat_t fx_fold(lpfloat_t val, lpfloat_t * prev, lpfloat_t samplerate) {
    // Adapted from https://ccrma.stanford.edu/~jatin/ComplexNonlinearities/Wavefolder.html
    lpfloat_t out = 0;
#if LP_FLOAT
    lpfloat_t z = tanhf(val) + (tanhf(*prev) * 0.9f);
    out = z + (-0.5f * sinf(2.f * (float)PI * val * (samplerate/2.f) / samplerate));
#else
    lpfloat_t z = tanh(val) + (tanh(*prev) * 0.9);
    out = z + (-0.5 * sin(2. * PI * val * (samplerate/2.) / samplerate));
#endif
    *prev = out;
    //return lpzapgremlins(out);
    return out;
}

lpfloat_t fx_limit(lpfloat_t val, lpfloat_t * prev, lpfloat_t threshold, lpfloat_t release, lpbuffer_t * del) {
    // Not gonna lie, chatgpt helped me with this... it's prolly wonky! 
    // TODO: comparative reading on simple limiter implementations
    lpfloat_t alpha, out, sample, absample, smoothgain, gain=1.f;
    int sample_idx;

    assert(del->channels == 1);
    assert(del->samplerate > 0);

    alpha = exp(-1.f / del->samplerate * release);
    sample_idx = (del->pos - 100 + del->length) % del->length; // 100 sample delay
    sample = del->data[sample_idx];

    absample = fabs(sample);    
    if(absample > threshold) gain = threshold / absample;

    smoothgain = alpha * (*prev) + (1.f - alpha) * gain;
    *prev = smoothgain;
    out = smoothgain * val;

    del->data[del->pos] = val;
    del->pos = (del->pos + 1) % del->length;

    return out;
}

void fx_norm(lpbuffer_t * buf, lpfloat_t ceiling) {
    lpfloat_t maxval, normval;
    size_t i;
    int c;

    maxval = mag_buffer(buf);
    normval = ceiling / maxval;

    for(i=0; i < buf->length; i++) {
        for(c=0; c < buf->channels; c++) {
            buf->data[i * buf->channels + c] *= normval;
        }
    }
}

lpfloat_t fx_crush(lpfloat_t val, int bits) {
    size_t intmax = 0;
    lpfloat_t out = val;

    if(bits <= 0) return 0.f;
    
    // multiply float val by int max to get int val
    intmax = pow(2, bits);
    out *= intmax;

    // truncate mantassa
    out = (lpfloat_t)((int)out); 

    // divide by int max and get crushed float back
    out /= (lpfloat_t)intmax;

    return out;
}

void fx_convolve(lpbuffer_t * a, lpbuffer_t * b, lpbuffer_t * out) {
    int c;
    size_t i, j;
    lpfloat_t maxval;

    assert(a->channels == b->channels);
    assert(a->channels == out->channels);
    assert(out->length == a->length + b->length + 1);

    maxval = mag_buffer(a);

    for(i=0; i < a->length; i++) {
        for(c=0; c < a->channels; c++) {
            for(j=0; j < b->length; j++) {
                out->data[(j+i) * a->channels + c] += a->data[i * a->channels + c] * b->data[j * a->channels + c];
            }
        }
    }

    fx_norm(out, maxval);
}


/* RingBuffers
 */
lpbuffer_t * ringbuffer_create(size_t length, int channels, int samplerate) {
    lpbuffer_t * ringbuf;
    ringbuf = LPBuffer.create(length, channels, samplerate);
    ringbuf->pos = 0;
    ringbuf->boundry = length - 1;
    return ringbuf;
}

void ringbuffer_fill(lpbuffer_t * ringbuf, lpbuffer_t * buf, int offset) {
    size_t i;
    int c;
    size_t pos = ringbuf->pos - buf->length - offset;
    pos = pos % ringbuf->length;
    for(i=0; i < buf->length; i++) {
        for(c=0; c < ringbuf->channels; c++) {
            buf->data[i * buf->channels + c] = ringbuf->data[pos * ringbuf->channels + c];
        }

        pos += 1;
        pos = pos % ringbuf->length;
    }
}

lpfloat_t ringbuffer_readone(lpbuffer_t * ringbuf, int offset) {
    return ringbuf->data[(ringbuf->pos - offset) % ringbuf->length];
}

void ringbuffer_readinto(lpbuffer_t * ringbuf, lpfloat_t * data, size_t length, int channels) {
    size_t i;
    int c;
    size_t pos = ringbuf->pos - length;
    pos = pos % ringbuf->length;

    for(i=0; i < length; i++) {
        for(c=0; c < channels; c++) {
            data[i * channels + c] = ringbuf->data[pos * channels + c];
        }

        pos += 1;
        pos = pos % ringbuf->length;
    }
}

lpbuffer_t * ringbuffer_read(lpbuffer_t * ringbuf, size_t length) {
    size_t i;
    int c;
    size_t pos = ringbuf->pos - length;
    lpbuffer_t * out;

    pos = pos % ringbuf->length;
    out = LPBuffer.create(length, ringbuf->channels, ringbuf->samplerate);
    for(i=0; i < length; i++) {
        for(c=0; c < ringbuf->channels; c++) {
            out->data[i * out->channels + c] = ringbuf->data[pos * ringbuf->channels + c];
        }

        pos += 1;
        pos = pos % ringbuf->length;
    }

    return out;
}

void ringbuffer_writeone(lpbuffer_t * ringbuf, lpfloat_t sample) {
    ringbuf->data[ringbuf->pos] = sample;
    ringbuf->pos += 1;
    ringbuf->pos = ringbuf->pos % ringbuf->length;
}

void ringbuffer_writefrom(lpbuffer_t * ringbuf, lpfloat_t * data, size_t length, int channels) {
    size_t i;
    int c, j;
    for(i=0; i < length; i++) {
        for(c=0; c < ringbuf->channels; c++) {
            j = c % channels;
            ringbuf->data[ringbuf->pos * ringbuf->channels + c] = data[i * channels + j];
        }

        ringbuf->pos += 1;
        ringbuf->pos = ringbuf->pos % ringbuf->length;
    }
}

void ringbuffer_write(lpbuffer_t * ringbuf, lpbuffer_t * buf) {
    size_t i;
    int c, j;
    for(i=0; i < buf->length; i++) {
        for(c=0; c < ringbuf->channels; c++) {
            j = c % buf->channels;
            ringbuf->data[ringbuf->pos * ringbuf->channels + c] = buf->data[i * buf->channels + j];
        }

        ringbuf->pos += 1;
        ringbuf->pos = ringbuf->pos % ringbuf->length;
    }
}

void ringbuffer_dub(lpbuffer_t * buf, lpbuffer_t * src) {
    size_t i;
    int c, j;
    for(i=0; i < src->length; i++) {
        for(c=0; c < buf->channels; c++) {
            j = c % src->channels;
            buf->data[buf->pos * buf->channels + c] += src->data[i * src->channels + j];
        }

        buf->pos += 1;
        buf->pos = buf->pos % buf->length;
    }
}

void ringbuffer_destroy(lpbuffer_t * buf) {
    LPBuffer.destroy(buf);
}


/* LPMemoryPool
 * */
void memorypool_init(unsigned char * pool, size_t poolsize) {
    assert(poolsize >= 1);
    LPMemoryPool.pool = pool;
    LPMemoryPool.poolsize = poolsize;
    LPMemoryPool.pos = 0;
}

lpmemorypool_t * memorypool_custom_init(unsigned char * pool, size_t poolsize) {
    lpmemorypool_t * mp;
    mp = (lpmemorypool_t *)LPMemoryPool.alloc(1, sizeof(lpmemorypool_t));

    assert(poolsize >= 1);
    mp->pool = pool;
    mp->poolsize = poolsize;
    mp->pos = 0;

    return mp;
}

void * memorypool_custom_alloc(lpmemorypool_t * mp, size_t itemcount, size_t itemsize) {
    void * p;
    size_t length;

    assert(mp->pool != 0); 
    length = itemcount * itemsize;

    if(mp->poolsize >= mp->pos + length) {
        p = (void *)(&mp->pool[mp->pos]);
        mp->pos += length;
        return p;
    }
    /* FIXME might as well try to expand the pool here */
    exit(EXIT_FAILURE);
}

void * memorypool_alloc(size_t itemcount, size_t itemsize) {
    void * p;
#ifdef LP_STATIC
    size_t size;
    size = itemcount * itemsize;
    assert(LPMemoryPool.pool != 0); 
    if(LPMemoryPool.poolsize >= LPMemoryPool.pos + size) {
        p = (void *)(&LPMemoryPool.pool[LPMemoryPool.pos]);
        LPMemoryPool.pos += size;
        return p;
    }
    exit(EXIT_FAILURE);
#else
    p = (void *)calloc(itemcount, itemsize);
    if(p == NULL) {
        fprintf(stderr, "Calloc returned null trying to alloc %d bytes. %s (%d)\n", (int)(itemcount * itemsize), strerror(errno), errno);
        exit(EXIT_FAILURE);
    }
    return p;
#endif
}

void memorypool_free(void * ptr) {
#ifndef LP_STATIC
    free(ptr);
#else
    (void)ptr;
#endif
}

/* Param
 * */
lpbuffer_t * param_create_from_float(lpfloat_t value) {
    lpbuffer_t * param = create_buffer(1, 1, DEFAULT_SAMPLERATE);
    param->data[0] = value;
    return param;
}

lpbuffer_t * param_create_from_int(int value) {
    lpbuffer_t * param = create_buffer(1, 1, DEFAULT_SAMPLERATE);
    param->data[0] = (lpfloat_t)value;
    return param;
}

/* Interpolation
 * */
lpfloat_t interpolate_hermite(lpbuffer_t* buf, lpfloat_t phase) {
    lpfloat_t y0, y1, y2, y3, frac;
    lpfloat_t c0, c1, c2, c3;
    int i0, i1, i2, i3;

    if(buf->range == 1) return buf->data[0];
    if(buf->range < 1) return 0;

    frac = phase - (int)phase;
    i1 = (int)phase;
    i2 = i1 + 1;
    i3 = i2 + 1;
    i0 = i1 - 1;

    y0 = 0;
    y1 = 0;
    y2 = 0;
    y3 = 0;

    if(i0 >= 0) y0 = buf->data[i0];
    if(i1 <= (int)buf->boundry) y1 = buf->data[i1];
    if(i2 <= (int)buf->boundry) y2 = buf->data[i2];
    if(i3 <= (int)buf->boundry) y3 = buf->data[i3];

    /* This part was taken from version #2 by James McCartney 
     * https://www.musicdsp.org/en/latest/Other/93-hermite-interpollation.html
     */
    c0 = y1;
    c1 = 0.5f * (y2 - y0);
    c3 = 1.5f * (y1 - y2) + 0.5f * (y3 - y0);
    c2 = y0 - y1 + c1 - c3;
    return ((c3 * frac + c2) * frac + c1) * frac + c0;
}

lpfloat_t interpolate_hermite_pos(lpbuffer_t* buf, lpfloat_t pos) {
    return interpolate_hermite(buf, pos * buf->length);
}

/* Interpolated read from a multichannel buffer
 */
lpfloat_t interpolate_linear_channel(lpbuffer_t* buf, lpfloat_t phase, int channel) {
    lpfloat_t frac, a, b;
    size_t i;

    if(buf->range == 1) return buf->data[0];
    
    frac = phase - (int)phase;
    i = (int)phase;

    if (i >= buf->boundry) return 0;

    a = buf->data[i * buf->channels + channel];
    b = buf->data[(i+1) * buf->channels + channel];

    return (1.0f - frac) * a + (frac * b);
}

/* Interpolated read from a single channel buffer
 */
lpfloat_t interpolate_linear(lpbuffer_t* buf, lpfloat_t phase) {
    lpfloat_t frac, a, b;
    size_t i;

    if(buf->range == 1) return buf->data[0];
    
    frac = phase - (int)phase;
    i = (int)phase;

    if (i >= buf->boundry) return 0;

    a = buf->data[i];
    b = buf->data[i+1];

    return (1.0f - frac) * a + (frac * b);
}

lpfloat_t interpolate_linear_pos(lpbuffer_t* buf, lpfloat_t pos) {
    return interpolate_linear(buf, pos * buf->length);
}

lpfloat_t interpolate_linear_pos2(lpfloat_t * buf, size_t length, lpfloat_t pos) {
    lpfloat_t frac, a, b, phase;
    size_t i;

    phase = pos * length;

    if(length == 1) return buf[0];
    
    frac = phase - (int)phase;
    i = (int)phase;

    if (i >= length-1) return 0;

    a = buf[i];
    b = buf[i+1];

    return (1.0f - frac) * a + (frac * b);
}

/* Wavetable generators
 * 
 * All these functions return a table of values 
 * of the given length with values between -1 and 1
 */
void wavetable_sine(lpfloat_t* out, int length) {
    int i;
    for(i=0; i < length; i++) {
        out[i] = sin((i/(lpfloat_t)length) * (lpfloat_t)PI * 2.0f);
    }
}

void wavetable_cosine(lpfloat_t* out, int length) {
    int i;
    for(i=0; i < length; i++) {
        out[i] = cos((i/(lpfloat_t)length) * (lpfloat_t)PI * 2.0f);
    }
}

void wavetable_square(lpfloat_t* out, int length) {
    int i;
    for(i=0; i < length; i++) {
        if(i < (length/2.0f)) {
            out[i] = 0.9999f;
        } else {
            out[i] = -0.9999f;
        }
    }
}

void wavetable_tri(lpfloat_t* out, int length) {
    int i;
    int offset = (int)(length * 0.25f);
    for(i=0; i < length; i++) {
        out[(i+offset) % length] = (lpfloat_t)fabs((i/(lpfloat_t)length) * 2.0f - 1.0f) * 2.0f - 1.0f;
    }
}

void wavetable_tri2(lpfloat_t* out, int length) {
    int i;
    for(i=0; i < length; i++) {
        out[i] = (lpfloat_t)fabs((i/(lpfloat_t)length) * 2.0f - 1.0f) * 2.0f - 1.0f;
    }
}

void wavetable_saw(lpfloat_t* out, int length) {
    int i;
    for(i=0; i < length; i++) {
        out[i] = (i/(lpfloat_t)length) * 2.f - 1.f;
    }
}

void wavetable_rsaw(lpfloat_t* out, int length) {
    int i;
    for(i=0; i < length; i++) {
        out[i] = (1.f - i/(lpfloat_t)length) * 2.f - 1.f;
    }
}

/* create a wavetable (-1 to 1) */
lpbuffer_t* create_wavetable(int name, size_t length) {
    lpbuffer_t* buf = LPBuffer.create(length, 1, DEFAULT_SAMPLERATE);
    if(name == WT_SINE) {
        wavetable_sine(buf->data, length);            
    } else if (name == WT_COS) {
        wavetable_cosine(buf->data, length);            
    } else if (name == WT_TRI) {
        wavetable_tri(buf->data, length);            
    } else if (name == WT_TRI2) {
        wavetable_tri2(buf->data, length);            
    } else if (name == WT_SQUARE) {
        wavetable_square(buf->data, length);            
    } else if (name == WT_SAW) {
        wavetable_saw(buf->data, length);            
    } else if (name == WT_RSAW) {
        wavetable_rsaw(buf->data, length);            
    } else if (name == WT_RND) {
        return create_wavetable(rand_choice(NUM_WAVETABLES), length);
    } else {
        wavetable_sine(buf->data, length);            
    }
    return buf;
}

lpbuffer_t * lpbuffer_create_stack(lpbuffer_t * (*table_creator)(int name, size_t length), int numtables, size_t * onsets, size_t * lengths, va_list vl) {
    lpbuffer_t * stack;
    lpbuffer_t * user_bufp;
    int i;
    size_t tablesize, stacklength, pos, j;
    lpbuffer_t ** bufs;
    size_t * tablesizes;
    int * tables;

    bufs = (lpbuffer_t **)LPMemoryPool.alloc(numtables, sizeof(lpbuffer_t *));
    tablesizes = (size_t *)LPMemoryPool.alloc(numtables, sizeof(size_t));
    tables = (int *)LPMemoryPool.alloc(numtables, sizeof(int));

    memset(bufs, 0, numtables * sizeof(lpbuffer_t *));
    memset(tablesizes, 0, numtables * sizeof(size_t));
    memset(tables, 0, numtables * sizeof(int));

    stacklength = 0;

    // first pass get all sizes
    for(i=0; i < numtables; i++) {
        tables[i] = va_arg(vl, int);
        if(tables[i] == WT_USER) {
            user_bufp = va_arg(vl, lpbuffer_t *);
            tablesizes[i] = user_bufp->length;
            bufs[i] = LPBuffer.clone(user_bufp);
            stacklength += tablesizes[i];
        } else {
            tablesize = va_arg(vl, int);
            stacklength += tablesize;
            tablesizes[i] = tablesize;
        }
    }

    stack = LPBuffer.create(stacklength, 1, DEFAULT_SAMPLERATE);
    if(stack == NULL) return NULL;

    pos = 0;
    for(i=0; i < numtables; i++) {
        if(tables[i] != WT_USER) {
            bufs[i] = table_creator(tables[i], tablesizes[i]); 
        }

        for(j=0; j < bufs[i]->length; j++) {
            stack->data[j + pos] = bufs[i]->data[j];
        }

        onsets[i] = pos;
        lengths[i] = tablesizes[i];

        pos += bufs[i]->length;

        LPMemoryPool.free(bufs[i]);
    }

    LPMemoryPool.free(tables);
    LPMemoryPool.free(tablesizes);
    LPMemoryPool.free(bufs);

    return stack;
}

lpbuffer_t * create_wavetable_stack(int numtables, size_t * onsets, size_t * lengths, ...) {
    lpbuffer_t * stack;
    va_list vl;
    va_start(vl, lengths);
    va_end(vl);
    stack = lpbuffer_create_stack(create_wavetable, numtables, onsets, lengths, vl);
    return stack;
}

lpbuffer_t * create_window_stack(int numtables, size_t * onsets, size_t * lengths, ...) {
    lpbuffer_t * stack;
    va_list vl;
    va_start(vl, lengths);
    stack = lpbuffer_create_stack(create_window, numtables, onsets, lengths, vl);
    va_end(vl);
    return stack;
}


void destroy_wavetable(lpbuffer_t* buf) {
    LPBuffer.destroy(buf);
}


/* Window generators
 *
 * All these functions return a table of values 
 * of the given length with values between 0 and 1
 */
void window_phasor(lpfloat_t* out, int length) {
    int i;
    for(i=0; i < length; i++) {
        out[i] = i/(lpfloat_t)length;      
    }
}

void window_rsaw(lpfloat_t* out, int length) {
    int i;
    for(i=0; i < length; i++) {
        out[i] = 1.f - (i/(lpfloat_t)length);
    }
}

void window_tri(lpfloat_t* out, int length) {
    int i;
    for(i=0; i < length; i++) {
        out[i] = fabs((i/(lpfloat_t)length) * 2.0f - 1.0f);
    }
}

void window_cosine(lpfloat_t* out, int length) {
    int i;
    for(i=0; i < length; i++) {
        out[i] = (lpfloat_t)cos((i/(lpfloat_t)length) * (lpfloat_t)PI);         
    }
}

void window_sine(lpfloat_t* out, int length) {
    int i;
    for(i=0; i < length; i++) {
        out[i] = (lpfloat_t)sin((i/(lpfloat_t)length) * (lpfloat_t)PI);         
    }
}

void window_sinein(lpfloat_t* out, int length) {
    int i;
    for(i=0; i < length; i++) {
        out[i] = (lpfloat_t)sin((i/(lpfloat_t)length) * (lpfloat_t)HALFPI);         
    }
}

void window_sineout(lpfloat_t* out, int length) {
    int i;
    for(i=0; i < length; i++) {
        out[i] = (lpfloat_t)sin(((i/(lpfloat_t)length) * (lpfloat_t)HALFPI) + (lpfloat_t)HALFPI);
    }
}

void window_hanning(lpfloat_t* out, int length) {
    int i;
    assert(length > 1);
    for(i=0; i < length; i++) {
        out[i] = 0.5f - 0.5f * (lpfloat_t)cos(2.0f * (lpfloat_t)PI * i / (length-1.0f));
    }
}

/* create a window (0 to 1) */
lpbuffer_t * create_window(int name, size_t length) {
    lpbuffer_t* buf = LPBuffer.create(length, 1, DEFAULT_SAMPLERATE);
    if(name == WIN_SINE) {
        window_sine(buf->data, length);            
    } else if (name == WIN_SINEIN) {
        window_sinein(buf->data, length);            
    } else if (name == WIN_SINEOUT) {
        window_sineout(buf->data, length);            
    } else if (name == WIN_COS) {
        window_cosine(buf->data, length);            
    } else if (name == WIN_TRI) {
        window_tri(buf->data, length);            
    } else if (name == WIN_PHASOR) {
        window_phasor(buf->data, length);            
    } else if (name == WIN_HANN) {
        window_hanning(buf->data, length);            
    } else if (name == WIN_SAW) {
        window_phasor(buf->data, length);            
    } else if (name == WIN_RSAW) {
        window_rsaw(buf->data, length);            
    } else if (name == WIN_RND) {
        return create_window(rand_choice(NUM_WINDOWS), length);
    } else {
        window_sine(buf->data, length);            
    }
    return buf;
}

void destroy_window(lpbuffer_t* buf) {
    LPBuffer.destroy(buf);
}

/* Utilities */

/* The zapgremlins() routine was written by James McCartney as part of SuperCollider:
 * https://github.com/supercollider/supercollider/blob/f0d4f47a33b57b1f855fe9ca2d4cb427038974f0/headers/plugin_interface/SC_InlineUnaryOp.h#L35
 *
 * SuperCollider real time audio synthesis system
 * Copyright (c) 2002 James McCartney. All rights reserved.
 * http://www.audiosynth.com
 *
 * He says:
 *      This is a function for preventing pathological math operations in ugens.
 *      It can be used at the end of a block to fix any recirculating filter values.
 */
lpfloat_t lpzapgremlins(lpfloat_t x) {
    lpfloat_t absx;
    absx = fabs(x);
    return (absx > (lpfloat_t)1e-15 && absx < (lpfloat_t)1e15) ? x : (lpfloat_t)0.f;
}

lpfloat_t lpfilternan(lpfloat_t x) {
    return isnan(x) ? 0.f : x;
}

lpfloat_t lpwv(lpfloat_t value, lpfloat_t min, lpfloat_t max) {
    /* wrap value */
    if(value > max) value -= max;
    if(value < min) value += min;
    return value;
}

lpfloat_t lpsv(lpfloat_t value, lpfloat_t min, lpfloat_t max) {
    /* scale value */
    return value * (max-min) + min;
}

lpfloat_t lpsvf(lpfloat_t value, lpfloat_t min, lpfloat_t max, lpfloat_t from, lpfloat_t to) {
    /* scale value from (a range other than 0-1) */
    lpfloat_t delta = to - from;
    if(delta <= 0) return 0;
    return (value/delta) * (max-min) + min;
}

lpfloat_t lpfmax(lpfloat_t a, lpfloat_t b) {
    if(isnan(a)) return b;
    if(isnan(b)) return a;
    return a < b ? b : a;
}

lpfloat_t lpfmin(lpfloat_t a, lpfloat_t b) {
    if (isnan(a)) return b;
    if (isnan(b)) return a;
    return a < b ? a : b;
}

lpfloat_t lpfabs(lpfloat_t value) {
    if(value <= 0) return value * -1;
    return value;
}

lpfloat_t lpfpow(lpfloat_t value, int exp) {
    int i;
    lpfloat_t result;

    assert(exp >= 0);

    result = 1.f;
    for(i=0; i < exp; i++) {
        result *= value;
    }
    return result;
}

/* FNV-1 hash implementation adapted from:
 * http://www.isthe.com/chongo/src/fnv/hash_32.c */
u_int32_t lphashstr(char * str) {
    u_int32_t hval = FNV1_32_MAGIC_NUMBER;
    unsigned char *s = (unsigned char *)str;	/* unsigned string */

    /* FNV-1 hash each octet in the buffer */
    while (*s) {
        /* multiply by the 32 bit FNV magic prime mod 2^32 */
        hval += (hval<<1) + (hval<<4) + (hval<<7) + (hval<<8) + (hval<<24);

        /* xor the bottom with the current octet */
        hval ^= (u_int32_t)*s++;
    }

    /* return our new hash value */
    return hval;
}
